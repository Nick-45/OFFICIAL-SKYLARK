<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDUSKYLARK · Subscription History</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --school-green: #27ae60;
            --school-green-dark: #229954;
            --dark-blue: #2c3e50;
            --white: #ffffff;
            --light-blue: #ecf0f1;
            --red: #e74c3c;
            --blue: #3498db;
            --orange: #e67e22;
            --purple: #9b59b6;
            --gold: #f1c40f;
            --gray-light: #f8f9fa;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #ecf0f1 0%, #d6dbdf 100%); }
        .background-animation { position: fixed; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .bubble { position: absolute; border-radius: 50%; background: rgba(39,174,96,0.1); animation: float 15s infinite ease-in-out; }
        @keyframes float { 0%,100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-20px) scale(1.05); } }
        .header { background: linear-gradient(135deg, #2c3e50, #1a2530); color: white; padding: 20px 30px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; }
        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo { width: 60px; height: 60px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .church-info h1 { font-size: 24px; }
        .church-info p { color: var(--school-green); }
        .school-badge { background: linear-gradient(135deg, var(--school-green), var(--school-green-dark)); color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px; margin-left: 10px; }
        .dashboard-container { max-width: 1200px; margin: 30px auto; padding: 0 20px; animation: fadeIn 0.8s ease-out; }
        
        .page-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;
        }
        .page-header h2 { font-size: 28px; display: flex; align-items: center; gap: 15px; }
        .page-header h2 i { color: var(--gold); }
        
        /* Subscription summary card */
        .summary-card {
            background: linear-gradient(135deg, var(--dark-blue), #1a2530);
            border-radius: 30px; padding: 30px; color: white; margin-bottom: 30px;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow);
        }
        .summary-plan { font-size: 32px; font-weight: 800; margin-bottom: 5px; }
        .summary-price { font-size: 24px; color: var(--gold); }
        .summary-next { background: rgba(255,255,255,0.1); padding: 15px 25px; border-radius: 20px; }
        
        /* Filter bar */
        .filter-bar {
            background: white; border-radius: 16px; padding: 20px; margin-bottom: 30px;
            display: flex; flex-wrap: wrap; align-items: center; gap: 20px;
            box-shadow: var(--shadow);
        }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        .filter-select {
            padding: 12px 20px; border: 2px solid #e9ecef; border-radius: 30px; background: white;
            font-size: 14px; min-width: 150px;
        }
        .search-box {
            flex: 1; display: flex; align-items: center; background: #f9f9f9; border-radius: 30px;
            padding: 5px 5px 5px 20px; border: 2px solid #e9ecef;
        }
        .search-box input {
            flex: 1; padding: 12px 0; border: none; background: transparent; outline: none;
        }
        .search-box button {
            background: linear-gradient(135deg, var(--gold), #f39c12);
            color: var(--dark-blue); border: none; padding: 12px 25px; border-radius: 30px; cursor: pointer; font-weight: 600;
        }
        
        /* Invoices table */
        .table-container {
            background: white; border-radius: 20px; padding: 25px; box-shadow: var(--shadow);
            overflow-x: auto;
        }
        table {
            width: 100%; border-collapse: collapse;
        }
        th {
            text-align: left; padding: 15px 10px; color: #7f8c8d; font-weight: 600; font-size: 14px;
            border-bottom: 2px solid #ecf0f1;
        }
        td {
            padding: 15px 10px; border-bottom: 1px solid #ecf0f1; color: var(--dark-blue);
        }
        .status-badge {
            padding: 6px 15px; border-radius: 30px; font-size: 12px; font-weight: 600; display: inline-block;
        }
        .status-paid { background: rgba(39,174,96,0.1); color: var(--school-green); }
        .status-pending { background: rgba(230,126,34,0.1); color: var(--orange); }
        .status-failed { background: rgba(231,76,60,0.1); color: var(--red); }
        
        .action-btn {
            background: none; border: none; color: var(--dark-blue); cursor: pointer; padding: 5px 10px;
            border-radius: 8px; transition: 0.2s;
        }
        .action-btn:hover { background: #ecf0f1; color: var(--gold); }
        
        .logout-btn {
            background: rgba(231,76,60,0.2); color: white; border: 2px solid var(--red);
            padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: 600;
            display: flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .logout-btn:hover { background: var(--red); }
        
        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; border-radius: 30px; max-width: 550px; width: 90%; padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3); animation: modalSlide 0.3s ease-out;
        }
        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .modal-header h3 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .modal-close {
            font-size: 28px; cursor: pointer; color: #999; transition: 0.2s;
        }
        .modal-close:hover { color: var(--red); }
        
        .invoice-detail {
            background: #f9f9f9; border-radius: 16px; padding: 20px; margin-bottom: 20px;
        }
        .detail-row {
            display: flex; justify-content: space-between; padding: 12px 0;
            border-bottom: 1px dashed #e0e0e0;
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: #7f8c8d; font-weight: 500; }
        .detail-value { font-weight: 700; color: var(--dark-blue); }
        
        .btn {
            padding: 14px 30px; border-radius: 30px; font-weight: 600; cursor: pointer; border: none;
            font-size: 16px; transition: 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--gold), #f39c12);
            color: var(--dark-blue);
        }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(241,196,15,0.3); }
        .btn-secondary {
            background: #f0f0f0; color: var(--dark-blue);
        }
        .btn-secondary:hover { background: #e0e0e0; }
        
        .empty-state {
            text-align: center; padding: 40px; color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo"><img src="logo.png" alt="EDUSKYLARK" onerror="this.src='https://cdn-icons-png.flaticon.com/512/217/217853.png'"></div>
                <div class="church-info">
                    <h1>EDUSKYLARK · SUBSCRIPTION HISTORY <span class="school-badge"><i class="fas fa-school"></i> <span id="schoolNameHeader">SCHOOL ADMIN</span></span></h1>
                    <p>Billing & Invoices · <span id="schoolNameSub">Loading...</span></p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <span style="color: white; background: rgba(39,174,96,0.2); padding: 5px 15px; border-radius: 30px;">
                    <i class="fas fa-user-shield"></i> <span id="adminName">Admin</span>
                </span>
                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </header>

    <main class="dashboard-container">
        <div class="page-header">
            <h2><i class="fas fa-file-invoice-dollar"></i> Subscription Invoices</h2>
            <a href="school-subscription.html" style="text-decoration: none;">
                <button class="btn btn-primary" style="background: var(--dark-blue); color: white;">
                    <i class="fas fa-arrow-left"></i> Back to Subscription
                </button>
            </a>
        </div>

        <!-- Current Plan Summary Card -->
        <div class="summary-card" id="summaryCard">
            <div>
                <div class="summary-plan" id="currentPlan">Premium Plan</div>
                <div class="summary-price" id="currentPrice">KES 25,000/month</div>
                <div style="margin-top: 10px; opacity: 0.9;" id="billingCycle">Billed monthly</div>
            </div>
            <div class="summary-next">
                <div style="font-size: 14px; opacity: 0.8;">Next invoice</div>
                <div style="font-size: 20px; font-weight: 700;" id="nextInvoiceDate">15 May 2025</div>
                <div style="font-size: 14px; margin-top: 5px;" id="nextInvoiceAmount">KES 25,000</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group">
                <label>Year:</label>
                <select class="filter-select" id="yearFilter">
                    <option value="all">All Years</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Status:</label>
                <select class="filter-select" id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="paid">Paid</option>
                    <option value="pending">Pending</option>
                    <option value="failed">Failed</option>
                </select>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by invoice number...">
                <button id="searchBtn"><i class="fas fa-search"></i> Search</button>
            </div>
        </div>

        <!-- Invoices Table -->
        <div class="table-container">
            <table id="invoicesTable">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Payment Method</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="invoicesBody">
                    <!-- Dynamic content -->
                </tbody>
            </table>
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-file-invoice" style="font-size: 48px; margin-bottom: 15px; color: #ccc;"></i>
                <h3>No invoices found</h3>
                <p>Your subscription invoices will appear here.</p>
            </div>
        </div>
    </main>

    <!-- Invoice Details Modal -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice" style="color: var(--gold);"></i> Invoice Details</h3>
                <span class="modal-close" id="closeModal">&times;</span>
            </div>
            <div class="invoice-detail" id="invoiceDetail">
                <!-- Dynamic content -->
            </div>
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button class="btn btn-secondary" id="downloadInvoiceBtn"><i class="fas fa-download"></i> Download PDF</button>
                <button class="btn btn-primary" id="closeInvoiceBtn">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAz5knhlAxZwUATy3mtW66Z6lHBrv4tUog",
            authDomain: "toplink-edu.firebaseapp.com",
            projectId: "toplink-edu",
            storageBucket: "toplink-edu.firebasestorage.app",
            messagingSenderId: "35786900143",
            appId: "1:35786900143:web:9e612336393d29324c0a5a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ========== DOM ELEMENTS ==========
        const schoolNameHeader = document.getElementById('schoolNameHeader');
        const schoolNameSub = document.getElementById('schoolNameSub');
        const adminName = document.getElementById('adminName');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Summary elements
        const currentPlan = document.getElementById('currentPlan');
        const currentPrice = document.getElementById('currentPrice');
        const nextInvoiceDate = document.getElementById('nextInvoiceDate');
        const nextInvoiceAmount = document.getElementById('nextInvoiceAmount');
        
        // Table elements
        const invoicesBody = document.getElementById('invoicesBody');
        const emptyState = document.getElementById('emptyState');
        const yearFilter = document.getElementById('yearFilter');
        const statusFilter = document.getElementById('statusFilter');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        
        // Modal elements
        const invoiceModal = document.getElementById('invoiceModal');
        const closeModal = document.getElementById('closeModal');
        const closeInvoiceBtn = document.getElementById('closeInvoiceBtn');
        const downloadInvoiceBtn = document.getElementById('downloadInvoiceBtn');
        const invoiceDetail = document.getElementById('invoiceDetail');

        // ========== STATE ==========
        let currentUser = null;
        let adminData = null;
        let schoolData = null;
        let allInvoices = [];
        let filteredInvoices = [];

        // ========== AUTH STATE LISTENER ==========
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadAdminData(user);
                if (!adminData) {
                    console.error('No admin record found');
                    await auth.signOut();
                    window.location.href = 'school-login.html';
                    return;
                }
                if (adminData.status !== 'Active') {
                    alert('Your account is not active. Please contact super admin.');
                    await auth.signOut();
                    window.location.href = 'school-login.html';
                    return;
                }
                updateUI();
                await loadSchoolData();
                await loadInvoices();
                setupEventListeners();
            } else {
                window.location.href = 'school-login.html';
            }
        });

        // ========== LOAD ADMIN DATA ==========
        async function loadAdminData(user) {
            try {
                const adminsQuery = await db.collection('admins')
                    .where('authUid', '==', user.uid)
                    .limit(1)
                    .get();

                if (!adminsQuery.empty) {
                    adminData = adminsQuery.docs[0].data();
                    adminData.id = adminsQuery.docs[0].id;
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        // ========== UPDATE UI ==========
        function updateUI() {
            if (!adminData) return;
            const fullName = adminData.name || 'School Administrator';
            adminName.textContent = fullName.split(' ')[0] || 'Admin';
            const schoolName = adminData.school || 'Your School';
            schoolNameHeader.textContent = schoolName;
            schoolNameSub.textContent = schoolName;
        }

        // ========== LOAD SCHOOL DATA ==========
        async function loadSchoolData() {
            if (!adminData) return;
            
            if (adminData.schoolId) {
                try {
                    const schoolDoc = await db.collection('schools').doc(adminData.schoolId).get();
                    if (schoolDoc.exists) {
                        schoolData = schoolDoc.data();
                        updateSummaryFromSchool();
                    }
                } catch (error) {
                    console.warn('Could not load school data', error);
                }
            }
            
            // Always set fallback summary
            updateSummary();
        }

        function updateSummaryFromSchool() {
            if (!schoolData) return;
            
            const plan = schoolData.plan || 'Premium';
            currentPlan.textContent = `${plan} Plan`;
            
            let price = 'KES 25,000/month';
            if (plan === 'Basic') price = 'KES 5,000/month';
            else if (plan === 'Standard') price = 'KES 12,000/month';
            currentPrice.textContent = price;
            
            if (schoolData.subscriptionExpiry) {
                const expiry = schoolData.subscriptionExpiry.toDate();
                nextInvoiceDate.textContent = expiry.toLocaleDateString('en-US', { 
                    day: 'numeric', month: 'short', year: 'numeric' 
                });
                
                let amount = '25,000';
                if (plan === 'Basic') amount = '5,000';
                else if (plan === 'Standard') amount = '12,000';
                nextInvoiceAmount.textContent = `KES ${amount}`;
            }
        }

        function updateSummary() {
            // Fallback summary if no school data
            currentPlan.textContent = 'Premium Plan';
            currentPrice.textContent = 'KES 25,000/month';
            
            const nextDate = new Date();
            nextDate.setMonth(nextDate.getMonth() + 1);
            nextInvoiceDate.textContent = nextDate.toLocaleDateString('en-US', { 
                day: 'numeric', month: 'short', year: 'numeric' 
            });
            nextInvoiceAmount.textContent = 'KES 25,000';
        }

        // ========== LOAD INVOICES ==========
        async function loadInvoices() {
            if (!adminData) return;
            
            try {
                let invoicesQuery;
                if (adminData.schoolId) {
                    invoicesQuery = db.collection('subscriptionInvoices')
                        .where('schoolId', '==', adminData.schoolId)
                        .orderBy('date', 'desc');
                } else {
                    invoicesQuery = db.collection('subscriptionInvoices')
                        .where('school', '==', adminData.school)
                        .orderBy('date', 'desc');
                }
                
                const snapshot = await invoicesQuery.get();
                allInvoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (allInvoices.length === 0) {
                    useMockInvoices();
                } else {
                    applyFilters();
                }
            } catch (error) {
                console.warn('Could not load invoices, using mock', error);
                useMockInvoices();
            }
        }

        // ========== MOCK INVOICES ==========
        function useMockInvoices() {
            allInvoices = [
                { 
                    id: 'inv1', 
                    invoiceNo: 'INV-2025-001', 
                    date: '2025-04-15', 
                    description: 'Premium Plan - April 2025', 
                    amount: 25000, 
                    method: 'M-Pesa', 
                    status: 'paid',
                    transactionId: 'MPE123456789',
                    billingPeriod: '1 Apr 2025 - 30 Apr 2025'
                },
                { 
                    id: 'inv2', 
                    invoiceNo: 'INV-2025-002', 
                    date: '2025-03-15', 
                    description: 'Premium Plan - March 2025', 
                    amount: 25000, 
                    method: 'Bank Transfer', 
                    status: 'paid',
                    transactionId: 'BT987654321',
                    billingPeriod: '1 Mar 2025 - 31 Mar 2025'
                },
                { 
                    id: 'inv3', 
                    invoiceNo: 'INV-2025-003', 
                    date: '2025-02-15', 
                    description: 'Premium Plan - February 2025', 
                    amount: 25000, 
                    method: 'Card', 
                    status: 'paid',
                    transactionId: 'CARD-4567-8901',
                    billingPeriod: '1 Feb 2025 - 28 Feb 2025'
                },
                { 
                    id: 'inv4', 
                    invoiceNo: 'INV-2025-004', 
                    date: '2025-05-15', 
                    description: 'Premium Plan - May 2025', 
                    amount: 25000, 
                    method: '—', 
                    status: 'pending',
                    transactionId: '',
                    billingPeriod: '1 May 2025 - 31 May 2025'
                },
                { 
                    id: 'inv5', 
                    invoiceNo: 'INV-2024-012', 
                    date: '2024-12-15', 
                    description: 'Premium Plan - December 2024', 
                    amount: 25000, 
                    method: 'M-Pesa', 
                    status: 'paid',
                    transactionId: 'MPE987654321',
                    billingPeriod: '1 Dec 2024 - 31 Dec 2024'
                },
                { 
                    id: 'inv6', 
                    invoiceNo: 'INV-2024-011', 
                    date: '2024-11-15', 
                    description: 'Premium Plan - November 2024', 
                    amount: 25000, 
                    method: 'Cheque', 
                    status: 'failed',
                    transactionId: '',
                    billingPeriod: '1 Nov 2024 - 30 Nov 2024'
                }
            ];
            applyFilters();
        }

        // ========== FILTER & RENDER ==========
        function applyFilters() {
            const yearVal = yearFilter.value;
            const statusVal = statusFilter.value;
            const searchVal = searchInput.value.toLowerCase();

            filteredInvoices = allInvoices.filter(inv => {
                if (yearVal !== 'all') {
                    const invYear = inv.date.split('-')[0];
                    if (invYear !== yearVal) return false;
                }
                if (statusVal !== 'all' && inv.status !== statusVal) return false;
                if (searchVal && !inv.invoiceNo.toLowerCase().includes(searchVal)) return false;
                return true;
            });

            renderTable();
        }

        function renderTable() {
            if (filteredInvoices.length === 0) {
                invoicesBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            let html = '';
            
            filteredInvoices.forEach(inv => {
                const statusClass = inv.status === 'paid' ? 'status-paid' : 
                                   inv.status === 'pending' ? 'status-pending' : 'status-failed';
                const statusText = inv.status.charAt(0).toUpperCase() + inv.status.slice(1);
                
                html += `
                    <tr>
                        <td><strong>${inv.invoiceNo}</strong></td>
                        <td>${new Date(inv.date).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' })}</td>
                        <td>${inv.description}</td>
                        <td><strong>KES ${inv.amount?.toLocaleString() || 0}</strong></td>
                        <td>${inv.method || '—'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn" onclick="viewInvoice('${inv.id}')"><i class="fas fa-eye"></i></button>
                            <button class="action-btn" onclick="downloadInvoice('${inv.id}')"><i class="fas fa-download"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            invoicesBody.innerHTML = html;
        }

        // ========== MODAL HANDLING ==========
        window.viewInvoice = function(id) {
            const invoice = allInvoices.find(i => i.id === id);
            if (!invoice) return;
            
            invoiceDetail.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Invoice Number:</span>
                    <span class="detail-value">${invoice.invoiceNo}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date:</span>
                    <span class="detail-value">${new Date(invoice.date).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Description:</span>
                    <span class="detail-value">${invoice.description}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Billing Period:</span>
                    <span class="detail-value">${invoice.billingPeriod || '—'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Amount:</span>
                    <span class="detail-value" style="color: var(--school-green); font-size: 18px;">KES ${invoice.amount?.toLocaleString() || 0}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Payment Method:</span>
                    <span class="detail-value">${invoice.method || '—'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Transaction ID:</span>
                    <span class="detail-value">${invoice.transactionId || '—'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value"><span class="status-badge status-${invoice.status}">${invoice.status.toUpperCase()}</span></span>
                </div>
            `;
            
            invoiceModal.style.display = 'flex';
        };

        window.downloadInvoice = function(id) {
            alert(`Download PDF for invoice ID: ${id}\n(In production, this would generate a PDF receipt.)`);
        };

        closeModal.addEventListener('click', () => {
            invoiceModal.style.display = 'none';
        });

        closeInvoiceBtn.addEventListener('click', () => {
            invoiceModal.style.display = 'none';
        });

        downloadInvoiceBtn.addEventListener('click', () => {
            // This would download the current invoice being viewed
            alert('Downloading invoice PDF...');
        });

        window.addEventListener('click', (e) => {
            if (e.target === invoiceModal) {
                invoiceModal.style.display = 'none';
            }
        });

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            logoutBtn.addEventListener('click', async () => {
                await auth.signOut();
                window.location.href = 'school-admin-login.html';
            });
            
            yearFilter.addEventListener('change', applyFilters);
            statusFilter.addEventListener('change', applyFilters);
            searchBtn.addEventListener('click', applyFilters);
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') applyFilters();
            });
        }
    </script>
</body>
</html>
