<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDUSKYLARK · Students</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --school-green: #27ae60;
            --school-green-dark: #229954;
            --dark-blue: #2c3e50;
            --white: #ffffff;
            --light-blue: #ecf0f1;
            --blue: #3498db;
            --red: #e74c3c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #ecf0f1 0%, #d6dbdf 100%); }
        .background-animation { position: fixed; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .bubble { position: absolute; border-radius: 50%; background: rgba(39,174,96,0.1); animation: float 15s infinite ease-in-out; }
        @keyframes float { 0%,100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-20px) scale(1.05); } }
        .header { background: linear-gradient(135deg, #2c3e50, #1a2530); color: white; padding: 20px 30px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; }
        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo { width: 60px; height: 60px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .church-info h1 { font-size: 24px; }
        .church-info p { color: var(--school-green); }
        .school-badge { background: linear-gradient(135deg, var(--school-green), var(--school-green-dark)); color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px; margin-left: 10px; }
        .dashboard-container { max-width: 1400px; margin: 30px auto; padding: 0 20px; animation: fadeIn 0.8s ease-out; }
        
        .page-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
        }
        .page-header h2 { font-size: 28px; display: flex; align-items: center; gap: 15px; }
        .page-header h2 i { color: var(--school-green); }
        
        .stats-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; border-radius: 16px; padding: 25px; border-left: 5px solid var(--school-green);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .stat-value { font-size: 36px; font-weight: 800; color: var(--dark-blue); }
        
        .filter-bar {
            background: white; border-radius: 16px; padding: 20px; margin-bottom: 30px;
            display: flex; flex-wrap: wrap; align-items: center; gap: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        .filter-select { padding: 12px 25px; border: 2px solid #e9ecef; border-radius: 30px; background: white; }
        .search-box {
            flex: 1; display: flex; align-items: center; background: #f9f9f9; border-radius: 30px;
            padding: 5px 5px 5px 20px; border: 2px solid #e9ecef;
        }
        .search-box input {
            flex: 1; padding: 12px 0; border: none; background: transparent; outline: none;
        }
        .search-box button {
            background: linear-gradient(135deg, var(--school-green), var(--school-green-dark));
            color: white; border: none; padding: 12px 25px; border-radius: 30px; cursor: pointer; font-weight: 600;
        }
        
        .students-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px;
        }
        .student-card {
            background: white; border-radius: 20px; padding: 25px; display: flex; align-items: center; gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: all 0.3s; border-left: 5px solid var(--school-green);
        }
        .student-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        
        .student-avatar {
            width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, var(--school-green), var(--school-green-dark));
            display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; font-weight: 700;
        }
        .student-info { flex: 1; }
        .student-name { font-size: 20px; font-weight: 700; color: var(--dark-blue); margin-bottom: 5px; }
        .student-meta { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; font-size: 13px; color: #666; }
        .badge { padding: 4px 12px; border-radius: 30px; font-size: 12px; font-weight: 600; }
        .badge-class { background: rgba(39,174,96,0.1); color: var(--school-green); }
        .badge-attendance { background: rgba(52,152,219,0.1); color: var(--blue); }
        
        .btn-view {
            background: rgba(39,174,96,0.1); color: var(--school-green); border: none;
            padding: 8px 20px; border-radius: 30px; font-weight: 600; cursor: pointer;
        }
        
        .add-btn {
            background: linear-gradient(135deg, var(--school-green), var(--school-green-dark));
            color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: 600;
            display: flex; align-items: center; gap: 8px; cursor: pointer;
        }

        .logout-btn {
            background: rgba(231,76,60,0.2); color: white; border: 2px solid var(--red);
            padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: 600;
            transition: all 0.3s; display: flex; align-items: center; gap: 8px;
        }
        .logout-btn:hover { background: var(--red); }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo"><img src="logo.png" alt="EDUSKYLARK" onerror="this.src='https://cdn-icons-png.flaticon.com/512/217/217853.png'"></div>
                <div class="church-info">
                    <h1>EDUSKYLARK · STUDENTS <span class="school-badge"><i class="fas fa-school"></i> <span id="schoolNameHeader">SCHOOL ADMIN</span></span></h1>
                    <p>Manage Student Records · <span id="schoolNameSub">Loading...</span></p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <span style="color: white; background: rgba(39,174,96,0.2); padding: 5px 15px; border-radius: 30px;" id="adminRoleDisplay">
                    <i class="fas fa-user-shield"></i> <span id="adminName">Admin</span>
                </span>
                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </header>

    <main class="dashboard-container">
        <div class="page-header">
            <h2><i class="fas fa-users"></i> Student Management</h2>
            <button class="add-btn" onclick="window.location.href='school-add-student.html'">
                <i class="fas fa-user-plus"></i> Add New Student
            </button>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div style="color: #666; font-size: 14px;">Total Students</div>
                <div class="stat-value" id="totalStudents">0</div>
                <div style="margin-top: 5px; color: var(--school-green);" id="studentGrowth">Loading...</div>
            </div>
            <div class="stat-card">
                <div style="color: #666; font-size: 14px;">Male</div>
                <div class="stat-value" style="color: var(--blue);" id="maleStudents">0</div>
            </div>
            <div class="stat-card">
                <div style="color: #666; font-size: 14px;">Female</div>
                <div class="stat-value" style="color: #e84393;" id="femaleStudents">0</div>
            </div>
            <div class="stat-card">
                <div style="color: #666; font-size: 14px;">Avg. Attendance</div>
                <div class="stat-value" style="color: var(--school-green);" id="avgAttendance">94%</div>
            </div>
        </div>

        <div class="filter-bar">
            <div class="filter-group">
                <label>Class:</label>
                <select class="filter-select" id="classFilter">
                    <option value="all">All Classes</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Status:</label>
                <select class="filter-select" id="statusFilter">
                    <option value="all">All</option>
                    <option value="Active">Active</option>
                    <option value="Graduated">Graduated</option>
                    <option value="Transferred">Transferred</option>
                </select>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by name or admission number...">
                <button id="searchBtn"><i class="fas fa-search"></i> Search</button>
            </div>
        </div>

        <div class="students-grid" id="studentsGrid">
            <!-- Dynamic student cards will be loaded here -->
            <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--school-green);"></i>
                <p style="margin-top: 20px; color: #666;">Loading students...</p>
            </div>
        </div>
    </main>

    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAz5knhlAxZwUATy3mtW66Z6lHBrv4tUog",
            authDomain: "toplink-edu.firebaseapp.com",
            projectId: "toplink-edu",
            storageBucket: "toplink-edu.firebasestorage.app",
            messagingSenderId: "35786900143",
            appId: "1:35786900143:web:9e612336393d29324c0a5a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ========== DOM ELEMENTS ==========
        const schoolNameHeader = document.getElementById('schoolNameHeader');
        const schoolNameSub = document.getElementById('schoolNameSub');
        const adminName = document.getElementById('adminName');
        const adminRoleDisplay = document.getElementById('adminRoleDisplay');
        const totalStudentsEl = document.getElementById('totalStudents');
        const maleStudentsEl = document.getElementById('maleStudents');
        const femaleStudentsEl = document.getElementById('femaleStudents');
        const avgAttendanceEl = document.getElementById('avgAttendance');
        const studentGrowthEl = document.getElementById('studentGrowth');
        const studentsGrid = document.getElementById('studentsGrid');
        const classFilter = document.getElementById('classFilter');
        const statusFilter = document.getElementById('statusFilter');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        // ========== STATE ==========
        let currentUser = null;
        let adminData = null;      // from 'admins' collection
        let allStudents = [];      // cached for filtering
        let uniqueClasses = new Set();

        // ========== AUTH STATE LISTENER ==========
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadAdminData(user);
                if (!adminData) {
                    console.error('No admin record found for this user');
                    await auth.signOut();
                    window.location.href = 'school-login.html';
                    return;
                }
                // Verify admin is active
                if (adminData.status !== 'Active') {
                    alert('Your account is not active. Please contact super admin.');
                    await auth.signOut();
                    window.location.href = 'school-login.html';
                    return;
                }
                // Load students for this admin's school
                await loadStudents();
                setupEventListeners();
            } else {
                window.location.href = 'school-login.html';
            }
        });

        // ========== LOAD ADMIN DATA FROM 'admins' COLLECTION ==========
        async function loadAdminData(user) {
            try {
                // Query admins collection where authUid matches current user uid
                const adminsQuery = await db.collection('admins')
                    .where('authUid', '==', user.uid)
                    .limit(1)
                    .get();

                if (!adminsQuery.empty) {
                    adminData = adminsQuery.docs[0].data();
                    adminData.id = adminsQuery.docs[0].id;
                    
                    // Update UI with admin data
                    const fullName = adminData.name || 'School Administrator';
                    adminName.textContent = fullName.split(' ')[0] || 'Admin';
                    
                    // Display school name
                    const schoolName = adminData.school || 'Your School';
                    schoolNameHeader.textContent = schoolName;
                    schoolNameSub.textContent = schoolName;
                    
                    // Update role display
                    const roleSpan = adminRoleDisplay.querySelector('i')?.parentNode || adminRoleDisplay;
                    if (adminData.role) {
                        roleSpan.innerHTML = `<i class="fas fa-user-shield"></i> ${adminData.role}`;
                    }
                    
                    console.log('Admin data loaded:', adminData);
                } else {
                    console.error('No admin document found for authUid:', user.uid);
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        // ========== LOAD STUDENTS ==========
        async function loadStudents() {
            if (!adminData) return;

            // Show loading state
            studentsGrid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--school-green);"></i>
                    <p style="margin-top: 20px; color: #666;">Loading students...</p>
                </div>
            `;

            try {
                // Determine school filter - support both schoolId and school name
                let studentsQuery;
                
                if (adminData.schoolId) {
                    // If we have a schoolId reference, use it
                    studentsQuery = db.collection('students')
                        .where('schoolId', '==', adminData.schoolId);
                } else {
                    // Fallback to school name string
                    studentsQuery = db.collection('students')
                        .where('school', '==', adminData.school);
                }

                const studentsSnap = await studentsQuery.get();
                
                // Map to array with ids
                allStudents = studentsSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Update stats
                updateStats(allStudents);
                
                // Extract unique classes for filter
                extractUniqueClasses(allStudents);
                
                // Render students
                renderStudents(allStudents);

            } catch (error) {
                console.error('Error loading students:', error);
                // Show demo data if no students exist
                loadDemoData();
            }
        }

        // ========== UPDATE STATISTICS ==========
        function updateStats(students) {
            const total = students.length;
            totalStudentsEl.textContent = total || 0;
            
            const maleCount = students.filter(s => s.gender?.toLowerCase() === 'male').length;
            const femaleCount = students.filter(s => s.gender?.toLowerCase() === 'female').length;
            
            maleStudentsEl.textContent = maleCount || 0;
            femaleStudentsEl.textContent = femaleCount || 0;
            
            // Calculate average attendance (mock for now)
            const avgAttendance = students.length > 0 
                ? Math.round(students.reduce((sum, s) => sum + (parseInt(s.attendanceRate) || 94), 0) / students.length) 
                : 94;
            avgAttendanceEl.textContent = `${avgAttendance}%`;
            
            // Growth indicator (mock)
            studentGrowthEl.textContent = total > 0 ? `+${Math.floor(total * 0.05)} this term` : 'No data';
        }

        // ========== EXTRACT UNIQUE CLASSES ==========
        function extractUniqueClasses(students) {
            uniqueClasses.clear();
            students.forEach(s => {
                if (s.class) uniqueClasses.add(s.class);
            });
            
            // Populate class filter dropdown
            let options = '<option value="all">All Classes</option>';
            Array.from(uniqueClasses).sort().forEach(className => {
                options += `<option value="${className}">${className}</option>`;
            });
            classFilter.innerHTML = options;
        }

        // ========== RENDER STUDENTS ==========
        function renderStudents(students) {
            if (!students || students.length === 0) {
                studentsGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 50px; background: white; border-radius: 20px;">
                        <i class="fas fa-user-graduate" style="font-size: 48px; color: #ccc;"></i>
                        <p style="margin-top: 20px; color: #666; font-size: 16px;">No students found</p>
                        <button onclick="window.location.href='school-add-student.html'" 
                                style="margin-top: 20px; background: var(--school-green); color: white; border: none; padding: 12px 25px; border-radius: 30px; cursor: pointer;">
                            <i class="fas fa-user-plus"></i> Add First Student
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            students.forEach(s => {
                const initials = s.fullName 
                    ? s.fullName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                    : 'ST';
                
                const admissionNo = s.admissionNo || s.admissionNumber || 'N/A';
                const className = s.class || 'Form 1A';
                const attendance = s.attendanceRate || s.attendance || '94%';
                
                html += `
                    <div class="student-card">
                        <div class="student-avatar">${initials}</div>
                        <div class="student-info">
                            <div class="student-name">${s.fullName || 'Student'}</div>
                            <div style="color: #666; font-size: 13px;">Adm: ${admissionNo}</div>
                            <div class="student-meta">
                                <span class="badge badge-class"><i class="fas fa-door-open"></i> ${className}</span>
                                <span class="badge badge-attendance"><i class="fas fa-calendar-check"></i> ${attendance}</span>
                                ${s.gender ? `<span style="margin-left: 5px;"><i class="fas fa-${s.gender === 'male' ? 'mars' : 'venus'}"></i> ${s.gender}</span>` : ''}
                            </div>
                        </div>
                        <button class="btn-view" onclick="viewStudent('${s.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </div>
                `;
            });
            studentsGrid.innerHTML = html;
        }

        // ========== FILTER STUDENTS ==========
        function filterStudents() {
            let filtered = [...allStudents];
            
            // Filter by class
            const classValue = classFilter.value;
            if (classValue !== 'all') {
                filtered = filtered.filter(s => s.class === classValue);
            }
            
            // Filter by status
            const statusValue = statusFilter.value;
            if (statusValue !== 'all') {
                filtered = filtered.filter(s => s.status === statusValue);
            }
            
            // Filter by search
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(s => 
                    (s.fullName?.toLowerCase().includes(searchTerm)) ||
                    (s.admissionNo?.toLowerCase().includes(searchTerm)) ||
                    (s.admissionNumber?.toLowerCase().includes(searchTerm))
                );
            }
            
            renderStudents(filtered);
        }

        // ========== LOAD DEMO DATA (if no students exist) ==========
        function loadDemoData() {
            const demoStudents = [
                { id: 'demo1', fullName: 'John Mwangi', admissionNo: '2025-001', class: 'Form 3C', gender: 'male', attendanceRate: '94%', status: 'Active' },
                { id: 'demo2', fullName: 'Mary Atieno', admissionNo: '2025-042', class: 'Form 3C', gender: 'female', attendanceRate: '98%', status: 'Active' },
                { id: 'demo3', fullName: 'Peter Kamau', admissionNo: '2024-128', class: 'Form 4A', gender: 'male', attendanceRate: '88%', status: 'Active' },
                { id: 'demo4', fullName: 'Alice Odhiambo', admissionNo: '2023-215', class: 'Form 3C', gender: 'female', attendanceRate: '95%', status: 'Active' },
                { id: 'demo5', fullName: 'Brian Muthama', admissionNo: '2023-218', class: 'Form 3C', gender: 'male', attendanceRate: '91%', status: 'Active' },
                { id: 'demo6', fullName: 'Sarah Njeri', admissionNo: '2022-089', class: 'Form 4A', gender: 'female', attendanceRate: '96%', status: 'Active' }
            ];
            
            allStudents = demoStudents;
            updateStats(allStudents);
            extractUniqueClasses(allStudents);
            renderStudents(allStudents);
            
            totalStudentsEl.textContent = '1,248'; // Override with demo count
            maleStudentsEl.textContent = '648';
            femaleStudentsEl.textContent = '600';
            studentGrowthEl.textContent = '+24 this term';
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            // Logout
            logoutBtn.addEventListener('click', async () => {
                await auth.signOut();
                window.location.href = 'school-login.html';
            });
            
            // Filter events
            classFilter.addEventListener('change', filterStudents);
            statusFilter.addEventListener('change', filterStudents);
            searchInput.addEventListener('input', filterStudents);
            searchBtn.addEventListener('click', filterStudents);
        }

        // ========== VIEW STUDENT DETAILS ==========
        window.viewStudent = function(id) {
            // Store student ID in session for details page
            sessionStorage.setItem('viewStudentId', id);
            window.location.href = `school-student-details.html?id=${id}`;
        };

        // Initialize on page load
        window.addEventListener('load', function() {
            // Any additional initialization
        });
    </script>
</body>
</html>
