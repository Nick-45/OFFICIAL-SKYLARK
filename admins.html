<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDUSKYLARK ¬∑ SUPER ADMIN ¬∑ AUTH FLOW</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        /* consistent design + modal system ‚Äì refined */
        :root { --blue: #3498db; --orange: #e67e22; --red: #e74c3c; --dark-blue: #2c3e50; --green: #27ae60; --gray-light: #ecf0f1; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #ecf0f1 0%, #d6dbdf 100%); font-family: 'Segoe UI', Roboto, sans-serif; }
        .header { background: linear-gradient(135deg, var(--dark-blue) 0%, #1a2530 100%); color: white; padding: 20px 30px; }
        .dashboard-container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(330px, 1fr)); gap: 25px; margin-top: 30px; }
        .admin-card { background: white; border-radius: 20px; padding: 25px; display: flex; align-items: flex-start; gap: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border-left: 5px solid var(--blue); transition: 0.2s; }
        .admin-card:hover { box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        .admin-avatar { width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, var(--blue), var(--dark-blue)); display: flex; align-items: center; justify-content: center; color: white; font-size: 26px; font-weight: 700; flex-shrink: 0; }
        .logout-btn { background: rgba(231,76,60,0.2); color: white; border: 2px solid var(--red); padding: 8px 20px; border-radius: 30px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .logout-btn:hover { background: var(--red); }
        .btn-primary { background: linear-gradient(135deg, var(--blue), var(--dark-blue)); color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-warning { background: linear-gradient(135deg, var(--orange), #d35400); color: white; border: none; padding: 8px 20px; border-radius: 30px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-warning:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .filter-search { background: white; border-radius: 30px; padding: 5px 5px 5px 20px; display: flex; align-items: center; width: 100%; border: 2px solid #e9ecef; }
        .filter-search input { flex:1; padding:12px 0; border:none; background:transparent; outline:none; }
        .badge-active { background: rgba(39,174,96,0.15); color: var(--green); padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-pending { background: rgba(230,126,34,0.15); color: var(--orange); padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-verified { background: rgba(52,152,219,0.15); color: var(--blue); padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-disabled { background: rgba(231,76,60,0.1); color: var(--red); padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .icon-btn { background: none; border: none; font-size: 16px; margin-left: 5px; cursor: pointer; color: #555; }
        .icon-btn:hover { color: var(--blue); }
        .icon-btn.delete:hover { color: var(--red); }
        .whatsapp-btn { background: #25D366; color: white; border-radius: 30px; padding: 6px 14px; font-size: 13px; border: none; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500; }
        .whatsapp-btn i { font-size: 15px; }
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 28px; max-width: 500px; width: 90%; padding: 30px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 24px; font-weight: 600; }
        .close-modal { font-size: 28px; cursor: pointer; color: #888; }
        .form-group { margin-bottom: 18px; }
        .form-group label { font-weight: 600; display: block; margin-bottom: 6px; }
        .form-control { width: 100%; padding: 12px 18px; border: 2px solid #e9ecef; border-radius: 16px; font-size: 15px; background: white; }
        .form-control:disabled { background: #f8f9fa; color: #6c757d; cursor: not-allowed; }
        .flex-row { display: flex; gap: 15px; flex-wrap: wrap; }
        .flex-row .form-group { flex: 1 1 200px; }
        .status-indicator { display: inline-flex; align-items: center; }
        .mt-3 { margin-top: 20px; }
        .wa-preview { background: #eafaf1; padding: 12px; border-radius: 14px; font-size: 13px; border-left: 4px solid #25D366; margin-bottom: 12px; }
        .required:after { content:" *"; color: var(--red); }
        .small-note { color: #6c757d; font-size: 12px; margin-top: 5px; }
        .verification-badge { display: inline-flex; align-items: center; gap: 5px; background: #edf2fa; border-radius: 30px; padding: 3px 12px; font-size: 12px; }
        .text-success { color: var(--green); }
        .text-muted { color: #6c757d; }
        .role-warning { color: var(--orange); font-size: 12px; margin-top: 4px; }
    </style>
</head>
<body>
    <header class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:20px;">
                <div class="logo" style="width:60px; height:60px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <img src="logo.png" style="width:45px;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/217/217853.png'">
                </div>
                <div>
                    <h1 style="font-size:24px;">EDUSKYLARK ¬∑ ADMINS <span style="background:linear-gradient(135deg,#f1c40f,#f39c12); color:var(--dark-blue); padding:3px 10px; border-radius:15px; font-size:12px; margin-left:10px;"><i class="fas fa-crown"></i> SUPER ADMIN</span></h1>
                    <p style="color:var(--blue);">Manage School Administrators ‚Äì One role per school</p>
                </div>
            </div>
            <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </header>

    <main class="dashboard-container">
        <!-- filter & invite row -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; flex-wrap:wrap;">
            <h2 style="font-size:28px;"><i class="fas fa-user-tie" style="color:var(--blue); margin-right:15px;"></i> School Administrators</h2>
            <button id="inviteAdminBtn" class="btn-primary" style="display:flex; align-items:center; gap:8px;"><i class="fas fa-user-plus"></i> Create Admin (with Auth)</button>
        </div>

        <!-- filter & search -->
        <div style="background:white; border-radius:20px; padding:25px; margin-bottom:30px; display:flex; gap:20px; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;">
                <label style="font-weight:600; display:block; margin-bottom:8px;">Filter by School</label>
                <select id="schoolFilterSelect" style="width:100%; padding:12px; border-radius:15px; border:2px solid #e9ecef;">
                    <option value="all">All Schools</option>
                </select>
            </div>
            <div style="flex:1; min-width:200px;">
                <label style="font-weight:600; display:block; margin-bottom:8px;">Role</label>
                <select id="roleFilterSelect" style="width:100%; padding:12px; border-radius:15px; border:2px solid #e9ecef;">
                    <option value="all">All Roles</option>
                    <option>Principal</option>
                    <option>Academic Admin</option>
                    <option>Finance Admin</option>
                    <option>Super Admin</option>
                </select>
            </div>
            <div style="flex:1; min-width:200px; display:flex; align-items:flex-end;">
                <div class="filter-search">
                    <input type="text" id="searchInput" placeholder="Search by name or email...">
                    <button style="background:linear-gradient(135deg, var(--blue), var(--dark-blue)); border:none; color:white; padding:12px 25px; border-radius:30px; cursor:pointer;"><i class="fas fa-search"></i></button>
                </div>
            </div>
        </div>

        <!-- Admin grid injected -->
        <div id="adminGridContainer" class="admin-grid"></div>
        <div id="noResultMsg" style="display:none; text-align:center; padding:50px; background:white; border-radius:30px;">üë®‚Äçüè´ No admins match the filters</div>
    </main>

    <!-- INVITE MODAL with SCHOOLS FROM COLLECTION + ROLE AVAILABILITY -->
    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-shield-alt" style="color:var(--blue);"></i> Create Admin Account</h3>
                <span class="close-modal" id="closeInviteModal">&times;</span>
            </div>
            <div class="form-group">
                <label class="required">Full Name</label>
                <input type="text" id="inviteName" class="form-control" placeholder="e.g. Mary Wambui">
            </div>
            <div class="form-group">
                <label class="required">Email (will receive verification)</label>
                <input type="email" id="inviteEmail" class="form-control" placeholder="admin@school.edu">
            </div>
            <div class="form-group">
                <label class="required">Temporary Password</label>
                <input type="password" id="invitePassword" class="form-control" placeholder="Min 6 characters" value="EduSkylark123!">
                <div class="small-note"><i class="fas fa-info-circle"></i> User must change password after first login</div>
            </div>
            <div class="flex-row">
                <div class="form-group">
                    <label class="required">Phone (WhatsApp)</label>
                    <input type="text" id="invitePhone" class="form-control" placeholder="+254 712 345678">
                </div>
                <div class="form-group">
                    <label class="required">Role</label>
                    <select id="inviteRole" class="form-control">
                        <option>Principal</option>
                        <option>Academic Admin</option>
                        <option>Finance Admin</option>
                    </select>
                    <div id="roleAvailabilityMsg" class="role-warning"></div>
                </div>
            </div>
            <div class="form-group">
                <label class="required">School</label>
                <select id="inviteSchoolSelect" class="form-control">
                    <option value="">-- Select School --</option>
                </select>
                <div class="small-note"><i class="fas fa-building"></i> Schools loaded from 'schools' collection</div>
            </div>
            <div class="form-group">
                <label>Initial Status (Firestore)</label>
                <select id="inviteStatus" class="form-control">
                    <option value="Active">Active</option>
                    <option value="Pending" selected>Pending (requires email verification)</option>
                </select>
            </div>
            <button id="saveInviteBtn" class="btn-primary" style="width:100%; padding:14px; font-size:16px;"><i class="fas fa-user-plus"></i> CREATE & SEND VERIFICATION</button>
            <p class="small-note" style="text-align:center; margin-top:10px;"><i class="fas fa-envelope"></i> Verification email will be sent automatically</p>
        </div>
    </div>

    <!-- EDIT MODAL (profile updates, with role/school availability check) -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit" style="color:var(--green);"></i> Edit Admin (profile only)</h3>
                <span class="close-modal" id="closeEditModal">&times;</span>
            </div>
            <input type="hidden" id="editDocId">
            <input type="hidden" id="editAuthUid">
            <div class="form-group">
                <label class="required">Full Name</label>
                <input type="text" id="editName" class="form-control">
            </div>
            <div class="form-group">
                <label class="required">Email</label>
                <input type="email" id="editEmail" class="form-control" readonly>
                <div class="small-note"><i class="fas fa-lock"></i> Email cannot be changed</div>
            </div>
            <div class="flex-row">
                <div class="form-group">
                    <label class="required">Phone (WhatsApp)</label>
                    <input type="text" id="editPhone" class="form-control">
                </div>
                <div class="form-group">
                    <label class="required">Role</label>
                    <select id="editRole" class="form-control">
                        <option>Principal</option>
                        <option>Academic Admin</option>
                        <option>Finance Admin</option>
                    </select>
                    <div id="editRoleAvailabilityMsg" class="role-warning"></div>
                </div>
            </div>
            <div class="form-group">
                <label class="required">School</label>
                <select id="editSchoolSelect" class="form-control">
                    <option value="">-- Select School --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="editStatus" class="form-control">
                    <option value="Active">Active</option>
                    <option value="Pending">Pending</option>
                </select>
            </div>
            <button id="updateAdminBtn" class="btn-primary" style="width:100%;"><i class="fas fa-sync-alt"></i> Update Profile</button>
        </div>
    </div>

    <!-- DELETE CONFIRM MODAL -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
                <h3 style="color:var(--red);"><i class="fas fa-exclamation-triangle"></i> Delete Account</h3>
                <span class="close-modal" id="closeDeleteModal">&times;</span>
            </div>
            <p style="margin:20px 0; font-size:16px;">Remove this administrator? <br><strong>This will also delete Firebase Auth user and Firestore record.</strong> Cannot be undone.</p>
            <input type="hidden" id="deleteDocId">
            <input type="hidden" id="deleteAuthUid">
            <div style="display:flex; gap:12px; justify-content:flex-end;">
                <button id="cancelDeleteBtn" style="padding:10px 20px; border-radius:30px; border:1px solid #ccc; background:white;">Cancel</button>
                <button id="confirmDeleteBtn" style="padding:10px 25px; background:var(--red); color:white; border:none; border-radius:30px;">Delete Permanently</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // Firebase config
            const firebaseConfig = {
                apiKey: "AIzaSyAz5knhlAxZwUATy3mtW66Z6lHBrv4tUog",
                authDomain: "toplink-edu.firebaseapp.com",
                projectId: "toplink-edu",
                storageBucket: "toplink-edu.firebasestorage.app",
                messagingSenderId: "35786900143",
                appId: "1:35786900143:web:9e612336393d29324c0a5a",
                measurementId: "G-3VSBS7R11D"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // Auth guard
            auth.onAuthStateChanged((user) => { if (!user) window.location.href = 'super-admin-login.html'; });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async () => { await auth.signOut(); window.location.href = 'super-admin-login.html'; });

            // ---------- GLOBAL STATE ----------
            let allAdmins = [];         // raw from firestore (admins collection)
            let allSchools = [];        // from schools collection {id, name}
            let assignedRolesMap = new Map(); // key: "schoolName_role" -> true if taken
            let schoolsSet = new Set();

            const adminGrid = document.getElementById('adminGridContainer');
            const noResult = document.getElementById('noResultMsg');
            const schoolFilter = document.getElementById('schoolFilterSelect');
            const roleFilter = document.getElementById('roleFilterSelect');
            const searchInput = document.getElementById('searchInput');

            // Modal elements
            const inviteModal = document.getElementById('inviteModal');
            const editModal = document.getElementById('editModal');
            const deleteModal = document.getElementById('deleteModal');
            const inviteSchoolSelect = document.getElementById('inviteSchoolSelect');
            const editSchoolSelect = document.getElementById('editSchoolSelect');
            const inviteRoleSelect = document.getElementById('inviteRole');
            const editRoleSelect = document.getElementById('editRole');
            const roleAvailabilityMsg = document.getElementById('roleAvailabilityMsg');
            const editRoleAvailabilityMsg = document.getElementById('editRoleAvailabilityMsg');

            // Close modal handlers
            document.getElementById('closeInviteModal').onclick = () => inviteModal.style.display = 'none';
            document.getElementById('closeEditModal').onclick = () => editModal.style.display = 'none';
            document.getElementById('closeDeleteModal').onclick = () => deleteModal.style.display = 'none';
            document.getElementById('cancelDeleteBtn').onclick = () => deleteModal.style.display = 'none';

            window.onclick = (e) => { 
                if (e.target === inviteModal) inviteModal.style.display = 'none'; 
                if (e.target === editModal) editModal.style.display = 'none'; 
                if (e.target === deleteModal) deleteModal.style.display = 'none'; 
            };

            // ---------- LOAD SCHOOLS FROM COLLECTION ----------
            async function loadSchools() {
                try {
                    const snapshot = await db.collection('schools').orderBy('name').get();
                    allSchools = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Populate school dropdowns
                    let options = '<option value="">-- Select School --</option>';
                    allSchools.forEach(school => {
                        const schoolName = school.name || 'Unnamed School';
                        options += `<option value="${schoolName.replace(/"/g, '&quot;')}">${schoolName}</option>`;
                    });
                    
                    if (inviteSchoolSelect) inviteSchoolSelect.innerHTML = options;
                    if (editSchoolSelect) editSchoolSelect.innerHTML = options;
                    
                    // Also update filter dropdown
                    updateSchoolFilterOptions();
                } catch (e) {
                    console.warn('Could not load schools collection, using fallback', e);
                    // Fallback options if schools collection doesn't exist
                    const fallback = ['Nairobi Adventist Academy', 'Kisumu Junior School', 'Mombasa Hill Academy'];
                    let options = '<option value="">-- Select School --</option>';
                    fallback.forEach(s => options += `<option>${s}</option>`);
                    if (inviteSchoolSelect) inviteSchoolSelect.innerHTML = options;
                    if (editSchoolSelect) editSchoolSelect.innerHTML = options;
                }
            }

            // ---------- BUILD ROLE ASSIGNMENT MAP ----------
            function buildRoleAssignmentMap(admins) {
                assignedRolesMap.clear();
                admins.forEach(admin => {
                    const data = admin.data;
                    if (data.school && data.role && data.status === 'Active') {
                        const key = `${data.school}_${data.role}`;
                        assignedRolesMap.set(key, admin.id); // store doc id for reference
                    }
                });
            }

            // ---------- CHECK IF ROLE IS AVAILABLE FOR SCHOOL ----------
            function isRoleAvailable(school, role, excludeDocId = null) {
                if (!school || !role) return true;
                const key = `${school}_${role}`;
                const existingDocId = assignedRolesMap.get(key);
                if (!existingDocId) return true;
                // If editing, allow same document to keep its role
                return excludeDocId && existingDocId === excludeDocId;
            }

            // ---------- UPDATE ROLE AVAILABILITY MESSAGE (Invite) ----------
            function updateInviteRoleAvailability() {
                const school = inviteSchoolSelect.value;
                const role = inviteRoleSelect.value;
                if (!school || !role) {
                    roleAvailabilityMsg.innerHTML = '';
                    document.getElementById('saveInviteBtn').disabled = false;
                    return;
                }
                
                const available = isRoleAvailable(school, role);
                if (available) {
                    roleAvailabilityMsg.innerHTML = '<span style="color: var(--green);"><i class="fas fa-check-circle"></i> Role available</span>';
                    document.getElementById('saveInviteBtn').disabled = false;
                } else {
                    roleAvailabilityMsg.innerHTML = '<span style="color: var(--red);"><i class="fas fa-times-circle"></i> This role is already assigned to an active admin at this school</span>';
                    document.getElementById('saveInviteBtn').disabled = true;
                }
            }

            // ---------- UPDATE ROLE AVAILABILITY MESSAGE (Edit) ----------
            function updateEditRoleAvailability() {
                const school = editSchoolSelect.value;
                const role = editRoleSelect.value;
                const docId = document.getElementById('editDocId').value;
                
                if (!school || !role) {
                    editRoleAvailabilityMsg.innerHTML = '';
                    document.getElementById('updateAdminBtn').disabled = false;
                    return;
                }
                
                const available = isRoleAvailable(school, role, docId);
                if (available) {
                    editRoleAvailabilityMsg.innerHTML = '<span style="color: var(--green);"><i class="fas fa-check-circle"></i> Role available</span>';
                    document.getElementById('updateAdminBtn').disabled = false;
                } else {
                    editRoleAvailabilityMsg.innerHTML = '<span style="color: var(--red);"><i class="fas fa-times-circle"></i> This role is already assigned to another active admin</span>';
                    document.getElementById('updateAdminBtn').disabled = true;
                }
            }

            // ---------- INVITE: CREATE AUTH USER + SEND VERIFICATION + SAVE TO FIRESTORE ----------
            document.getElementById('inviteAdminBtn').addEventListener('click', () => {
                // Clear form
                document.getElementById('inviteName').value = ''; 
                document.getElementById('inviteEmail').value = ''; 
                document.getElementById('invitePhone').value = ''; 
                document.getElementById('inviteRole').value = 'Principal'; 
                document.getElementById('inviteStatus').value = 'Pending';
                document.getElementById('invitePassword').value = 'EduSkylark123!';
                
                // Reset school dropdown and load schools
                loadSchools().then(() => {
                    if (inviteSchoolSelect) inviteSchoolSelect.value = '';
                });
                
                roleAvailabilityMsg.innerHTML = '';
                document.getElementById('saveInviteBtn').disabled = false;
                inviteModal.style.display = 'flex';
            });

            // Role/school change listeners for invite modal
            inviteSchoolSelect.addEventListener('change', updateInviteRoleAvailability);
            inviteRoleSelect.addEventListener('change', updateInviteRoleAvailability);

            // Save invite
            document.getElementById('saveInviteBtn').addEventListener('click', async () => {
                const name = document.getElementById('inviteName').value.trim();
                const email = document.getElementById('inviteEmail').value.trim();
                const password = document.getElementById('invitePassword').value.trim();
                const phone = document.getElementById('invitePhone').value.trim();
                const role = document.getElementById('inviteRole').value;
                const school = document.getElementById('inviteSchoolSelect').value;
                const status = document.getElementById('inviteStatus').value;

                if (!name || !email || !password || !phone || !school) { 
                    alert('All required fields must be filled.'); 
                    return; 
                }
                if (password.length < 6) { 
                    alert('Password must be at least 6 characters'); 
                    return; 
                }

                // Double-check role availability
                if (!isRoleAvailable(school, role)) {
                    alert('This role is already taken at this school. Please choose another role.');
                    return;
                }

                try {
                    // Create Firebase Auth user
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const firebaseUser = userCredential.user;
                    
                    // Send verification email
                    await firebaseUser.sendEmailVerification({
                        url: 'https://toplink-edu.firebaseapp.com/admin-login',
                        handleCodeInApp: true
                    });
                    
                    // Prepare Firestore doc
                    const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0,2);
                    const newAdmin = {
                        authUid: firebaseUser.uid,
                        name, email, phone, role, school, status,
                        emailVerified: firebaseUser.emailVerified,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        initials,
                    };
                    
                    await db.collection('admins').add(newAdmin);
                    
                    // Update displayName
                    await firebaseUser.updateProfile({ displayName: name });
                    
                    inviteModal.style.display = 'none';
                    alert(`Verification email sent to ${email}. User must verify before login.`);
                    fetchAdmins(); // refresh
                } catch(e) { 
                    console.error(e);
                    alert('Error: '+ e.message); 
                }
            });

            // ---------- EDIT: populate & show ----------
            window.openEditModal = async (docId, adminData) => {
                document.getElementById('editDocId').value = docId;
                document.getElementById('editAuthUid').value = adminData.authUid || '';
                document.getElementById('editName').value = adminData.name || '';
                document.getElementById('editEmail').value = adminData.email || '';
                document.getElementById('editPhone').value = adminData.phone || '';
                document.getElementById('editRole').value = adminData.role || 'Principal';
                document.getElementById('editStatus').value = adminData.status || 'Active';
                
                // Load schools and set selected
                await loadSchools();
                if (editSchoolSelect) {
                    editSchoolSelect.value = adminData.school || '';
                }
                
                editRoleAvailabilityMsg.innerHTML = '';
                document.getElementById('updateAdminBtn').disabled = false;
                editModal.style.display = 'flex';
            };

            // Role/school change listeners for edit modal
            editSchoolSelect.addEventListener('change', updateEditRoleAvailability);
            editRoleSelect.addEventListener('change', updateEditRoleAvailability);

            // Update admin
            document.getElementById('updateAdminBtn').addEventListener('click', async () => {
                const docId = document.getElementById('editDocId').value;
                const school = document.getElementById('editSchoolSelect').value;
                const role = document.getElementById('editRole').value;
                
                // Check role availability (excluding current doc)
                if (!isRoleAvailable(school, role, docId)) {
                    alert('This role is already assigned to another active admin at this school.');
                    return;
                }

                const updated = {
                    name: document.getElementById('editName').value.trim(),
                    phone: document.getElementById('editPhone').value.trim(),
                    role: role,
                    school: school,
                    status: document.getElementById('editStatus').value,
                    initials: document.getElementById('editName').value.trim().split(' ').map(n=>n[0]).join('').toUpperCase().substring(0,2)
                };
                
                if (!updated.name || !updated.phone || !updated.school) { 
                    alert('Fill required fields'); 
                    return; 
                }
                
                try {
                    await db.collection('admins').doc(docId).update(updated);
                    editModal.style.display = 'none';
                    fetchAdmins();
                } catch(e) { 
                    alert(e); 
                }
            });

            // ---------- DELETE ----------
            window.openDeleteModal = (docId, authUid) => {
                document.getElementById('deleteDocId').value = docId;
                document.getElementById('deleteAuthUid').value = authUid || '';
                deleteModal.style.display = 'flex';
            };
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                const docId = document.getElementById('deleteDocId').value;
                const authUid = document.getElementById('deleteAuthUid').value;
                try {
                    await db.collection('admins').doc(docId).delete();
                    
                    if (authUid) {
                        console.warn('Auth user not deleted client-side. Use Firebase Console.');
                        alert(`Firestore admin deleted. Auth user (${authUid}) was NOT deleted automatically. Please delete manually from Firebase Console for complete removal.`);
                    }
                    deleteModal.style.display = 'none';
                    fetchAdmins();
                } catch(e) { 
                    alert('Delete error: '+ e); 
                }
            });

            // ---------- WHATSAPP INTEGRATION ----------
            window.whatsappRedirect = (phone, adminName, school, role) => {
                let cleanPhone = phone.replace(/\D/g,'');
                if (!cleanPhone.startsWith('254') && cleanPhone.startsWith('0')) cleanPhone = '254'+cleanPhone.substring(1);
                else if (!cleanPhone.startsWith('254')) cleanPhone = '254'+cleanPhone;
                const message = `Hello ${adminName},%0a%0aI'm from EDUSKYLARK Super Admin.%0aSchool: *${school}*%0aRole: *${role}*%0a%0aYour admin account has been created. Please check your email (including spam) for verification link. Use your credentials to login. Kindly confirm receipt. Thank you!`;
                window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
            };

            // ---------- RENDER ADMIN CARDS ----------
            function renderAdmins(adminsArray) {
                if (!adminsArray.length) { 
                    adminGrid.innerHTML = ''; 
                    noResult.style.display = 'block'; 
                    return; 
                }
                noResult.style.display = 'none';
                let html = '';
                adminsArray.forEach(admin => {
                    const { id, data } = admin;
                    const name = data.name || 'Admin', email = data.email || '', phone = data.phone || '+254700000000';
                    const role = data.role || 'Admin', school = data.school || 'Unknown School', status = data.status || 'Active';
                    const initials = data.initials || (name.split(' ').map(n=>n[0]).join('').toUpperCase().substring(0,2));
                    const statusClass = status === 'Active' ? 'badge-active' : 'badge-pending';
                    
                    const emailVerified = data.emailVerified === true; 
                    const verifiedBadge = emailVerified ? 
                        '<span class="verification-badge" style="background:#e3f2fd;"><i class="fas fa-check-circle text-success"></i> Verified</span>' : 
                        '<span class="verification-badge" style="background:#fff3e0;"><i class="fas fa-clock" style="color:var(--orange);"></i> Not verified</span>';
                    
                    html += `<div class="admin-card">
                        <div class="admin-avatar">${initials}</div>
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3 style="font-size:18px; font-weight:700;">${name}</h3>
                                <button onclick="whatsappRedirect('${phone}', '${name.replace(/'/g,"\\'")}', '${school.replace(/'/g,"\\'")}', '${role}')" class="whatsapp-btn"><i class="fab fa-whatsapp"></i> WA</button>
                            </div>
                            <p style="color:var(--blue); font-size:14px; margin-bottom:5px;"><i class="fas fa-badge"></i> ${role}</p>
                            <p style="color:#666; font-size:13px;"><i class="fas fa-school"></i> ${school}</p>
                            <p style="color:#666; font-size:13px;"><i class="fas fa-envelope"></i> ${email} ${verifiedBadge}</p>
                            <p style="color:#666; font-size:13px;"><i class="fas fa-phone-alt"></i> ${phone} <span style="background:#e8f5e9; padding:2px 8px; border-radius:30px; margin-left:5px; font-size:11px;"><i class="fab fa-whatsapp" style="color:#25D366;"></i> WA</span></p>
                            <div style="margin-top:14px; display:flex; gap:8px; align-items:center;">
                                <span class="${statusClass}">${status}</span>
                                <button onclick='openEditModal("${id}", ${JSON.stringify(data).replace(/'/g, "&apos;")})' class="icon-btn" style="color:var(--blue);"><i class="fas fa-edit"></i></button>
                                <button onclick='openDeleteModal("${id}", "${data.authUid || ''}")' class="icon-btn delete" style="color:var(--red);"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>`;
                });
                adminGrid.innerHTML = html;
            }

            // Filter function
            function filterAndRender() {
                let filtered = allAdmins;
                const schoolVal = schoolFilter.value;
                const roleVal = roleFilter.value;
                const searchVal = searchInput.value.toLowerCase();

                if (schoolVal !== 'all') filtered = filtered.filter(a => a.data.school === schoolVal);
                if (roleVal !== 'all') filtered = filtered.filter(a => a.data.role === roleVal);
                if (searchVal) {
                    filtered = filtered.filter(a => 
                        a.data.name?.toLowerCase().includes(searchVal) || 
                        a.data.email?.toLowerCase().includes(searchVal) ||
                        a.data.phone?.includes(searchVal)
                    );
                }
                renderAdmins(filtered);
            }

            // Update school filter dropdown based on admins
            function updateSchoolFilterOptions() {
                let schoolOptions = '<option value="all">All Schools</option>';
                Array.from(schoolsSet).sort().forEach(s => schoolOptions += `<option>${s}</option>`);
                schoolFilter.innerHTML = schoolOptions;
            }

            // Fetch admins and update state
            async function fetchAdmins() {
                try {
                    const snapshot = await db.collection('admins').orderBy('createdAt', 'desc').get();
                    allAdmins = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                    
                    // Update schools set from admins
                    schoolsSet.clear();
                    allAdmins.forEach(a => { if (a.data.school) schoolsSet.add(a.data.school); });
                    
                    // Build role assignment map
                    buildRoleAssignmentMap(allAdmins);
                    
                    // Update filter dropdown
                    updateSchoolFilterOptions();
                    
                    filterAndRender();
                } catch (e) { 
                    console.warn('fetch err, seeding sample?', e); 
                    seedSample(); 
                }
            }

            // Seed sample data if empty
            async function seedSample() {
                // First ensure schools exist
                const schoolsRef = db.collection('schools');
                const schoolsSnapshot = await schoolsRef.get();
                if (schoolsSnapshot.empty) {
                    const sampleSchools = [
                        { name: 'Nairobi Adventist Academy', code: 'NAA' },
                        { name: 'Kisumu Junior School', code: 'KJS' },
                        { name: 'Mombasa Hill Academy', code: 'MHA' }
                    ];
                    for (let s of sampleSchools) {
                        await schoolsRef.add(s);
                    }
                }
                
                // Sample admins
                const sample = [
                    { name: 'John Mwangi', email: 'john@naa.edu', phone: '+254722111222', role: 'Principal', school: 'Nairobi Adventist Academy', status: 'Active', initials: 'JM', authUid: 'mockUid1', emailVerified: true, createdAt: new Date() },
                    { name: 'Alice Odhiambo', email: 'alice@kjs.edu', phone: '+254733333444', role: 'Academic Admin', school: 'Kisumu Junior School', status: 'Active', initials: 'AO', authUid: 'mockUid2', emailVerified: false, createdAt: new Date() },
                    { name: 'Mohammed Kassim', email: 'mk@mha.ac.ke', phone: '+254711555666', role: 'Finance Admin', school: 'Mombasa Hill Academy', status: 'Pending', initials: 'MK', authUid: 'mockUid3', emailVerified: false, createdAt: new Date() }
                ];
                for (let s of sample) {
                    await db.collection('admins').add(s);
                }
                
                // Reload everything
                await loadSchools();
                fetchAdmins();
            }

            // Event listeners for filters
            schoolFilter.addEventListener('change', filterAndRender);
            roleFilter.addEventListener('change', filterAndRender);
            searchInput.addEventListener('input', filterAndRender);

            // Initial load
            loadSchools().then(() => fetchAdmins());

            // Expose to window
            window.openEditModal = window.openEditModal;
            window.openDeleteModal = window.openDeleteModal;
            window.whatsappRedirect = window.whatsappRedirect;
        })();
    </script>
</body>
</html>
