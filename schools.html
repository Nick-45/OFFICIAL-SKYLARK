<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDUSKYLARK ¬∑ Schools Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        /* Your existing CSS remains exactly the same */
        :root { 
            --blue: #3498db; 
            --orange: #e67e22; 
            --red: #e74c3c; 
            --dark-blue: #2c3e50; 
            --white: #ffffff; 
            --light-blue: #ecf0f1; 
            --green: #27ae60; 
            --purple: #9b59b6;
            --shadow: 0 15px 35px rgba(0,0,0,0.05);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        body { 
            background: linear-gradient(135deg, #ecf0f1 0%, #d6dbdf 100%); 
            min-height: 100vh; 
            color: var(--dark-blue);
        }
        .background-animation {
            position: fixed; width: 100%; height: 100%; z-index: -1; overflow: hidden;
        }
        .bubble { 
            position: absolute; 
            border-radius: 50%; 
            background: rgba(52,152,219,0.08); 
            animation: float 18s infinite ease-in-out;
        }
        @keyframes float { 0%,100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-30px) scale(1.02); } }
        
        .header { 
            background: linear-gradient(135deg, var(--dark-blue) 0%, #1a2530 100%); 
            color: white; 
            padding: 20px 30px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; }
        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo { width: 60px; height: 60px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .logo img { width: 45px; }
        .church-info h1 { font-size: 24px; font-weight: 700; }
        .church-info p { font-size: 14px; color: var(--blue); }
        .admin-badge { 
            display: inline-flex; align-items: center; gap: 5px; 
            background: linear-gradient(135deg, #f1c40f, #f39c12); 
            color: var(--dark-blue); padding: 3px 12px; border-radius: 30px; font-size: 12px; margin-left: 10px;
        }
        .logout-btn {
            background: rgba(231,76,60,0.2); color: white; border: 2px solid var(--red);
            padding: 8px 20px; border-radius: 30px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .logout-btn:hover { background: var(--red); }
        
        .dashboard-container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; }
        .page-header h2 { font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 15px; }
        .page-header h2 i { color: var(--blue); }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--blue), var(--dark-blue)); border: none;
            color: white; padding: 12px 28px; border-radius: 40px; font-weight: 600; 
            cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s;
            font-size: 15px;
        }
        .btn-primary:hover { transform: scale(1.02); opacity: 0.9; }
        
        .stats-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;
        }
        .stat-mini-card {
            background: white; border-radius: 20px; padding: 22px; display: flex; align-items: center; gap: 18px;
            box-shadow: var(--shadow); border-left: 5px solid var(--blue);
        }
        .stat-mini-icon {
            width: 55px; height: 55px; border-radius: 16px; background: rgba(52,152,219,0.12);
            display: flex; align-items: center; justify-content: center; color: var(--blue); font-size: 24px;
        }
        .stat-mini-info h4 { font-size: 15px; color: #5d6d7e; margin-bottom: 6px; }
        .stat-mini-info span { font-size: 28px; font-weight: 700; color: var(--dark-blue); }
        
        .filter-bar {
            background: white; border-radius: 20px; padding: 22px 25px; margin-bottom: 30px;
            display: flex; flex-wrap: wrap; align-items: center; gap: 20px; 
            box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.5);
        }
        .filter-group { display: flex; align-items: center; gap: 12px; }
        .filter-group label { font-weight: 600; color: var(--dark-blue); font-size: 14px; }
        .filter-select {
            padding: 10px 24px 10px 18px; border: 2px solid #e9ecef; border-radius: 40px; background: white;
            font-size: 14px; cursor: pointer; outline: none; transition: 0.2s; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%232c3e50' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 15px center; background-size: 14px;
        }
        .filter-select:focus { border-color: var(--blue); }
        
        .search-box {
            flex: 1; min-width: 260px; display: flex; align-items: center; background: #f8fafb;
            border-radius: 50px; padding: 5px 5px 5px 22px; border: 2px solid #e9ecef; transition: 0.2s;
        }
        .search-box:focus-within { border-color: var(--blue); background: white; }
        .search-box input {
            flex: 1; padding: 12px 0; border: none; background: transparent; outline: none; font-size: 15px;
        }
        .search-box button {
            background: linear-gradient(135deg, var(--blue), var(--dark-blue)); border: none;
            color: white; padding: 12px 28px; border-radius: 50px; cursor: pointer; font-weight: 600;
            display: flex; align-items: center; gap: 6px;
        }
        
        .schools-table-container {
            background: white; border-radius: 28px; padding: 30px; box-shadow: var(--shadow);
            backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.6);
        }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 18px 12px; color: var(--dark-blue); font-weight: 600; border-bottom: 2px solid #e2e9f0; }
        td { padding: 22px 12px; border-bottom: 1px solid #f0f4f8; vertical-align: middle; }
        .school-info { display: flex; align-items: center; gap: 15px; }
        .school-avatar {
            width: 50px; height: 50px; border-radius: 16px; background: linear-gradient(145deg, #eef6fc, #dbeafe);
            display: flex; align-items: center; justify-content: center; color: var(--blue); font-weight: 700; font-size: 18px;
        }
        .school-name { font-weight: 700; color: var(--dark-blue); margin-bottom: 4px; font-size: 16px; }
        .school-email { font-size: 13px; color: #5f6b7a; }
        
        .status-badge { 
            padding: 7px 18px; border-radius: 50px; font-size: 12px; font-weight: 600; display: inline-block;
            letter-spacing: 0.3px;
        }
        .status-active { background: rgba(39,174,96,0.14); color: #1e7a44; }
        .status-pending { background: rgba(230,126,34,0.14); color: #b45f1a; }
        .status-expiring { background: rgba(231,76,60,0.14); color: #b03a2e; }
        .status-suspended { background: rgba(44,62,80,0.12); color: #1e2b38; }
        
        .action-btn-small {
            padding: 8px 18px; border-radius: 30px; border: none; font-weight: 600; cursor: pointer;
            transition: all 0.2s; margin-right: 6px; font-size: 13px; background: transparent;
        }
        .btn-view { background: rgba(52,152,219,0.08); color: var(--blue); border: 1px solid rgba(52,152,219,0.3); }
        .btn-edit { background: rgba(230,126,34,0.08); color: var(--orange); border: 1px solid rgba(230,126,34,0.3); }
        .btn-delete { background: rgba(231,76,60,0.08); color: var(--red); border: 1px solid rgba(231,76,60,0.3); }
        .btn-view:hover { background: rgba(52,152,219,0.2); }
        .btn-edit:hover { background: rgba(230,126,34,0.2); }
        .btn-delete:hover { background: rgba(231,76,60,0.2); }
        
        .pagination {
            display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 35px;
        }
        .page-btn {
            width: 42px; height: 42px; border-radius: 14px; border: 1px solid #dee6ed;
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
            background: white; font-weight: 500;
        }
        .page-btn.active { background: var(--blue); color: white; border-color: var(--blue); }
        .page-btn:hover:not(.active) { background: #f1f7fd; }
        
        .empty-state {
            text-align: center; padding: 50px 20px; color: #6c7a89;
        }
        .empty-state i { font-size: 48px; color: var(--blue); opacity: 0.6; margin-bottom: 16px; }
        
        #loadingIndicator i { font-size: 32px; }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="bubble" style="width:180px; height:180px; top:10%; left:5%;"></div>
        <div class="bubble" style="width:250px; height:250px; bottom:10%; right:5%; animation-delay: 2s;"></div>
        <div class="bubble" style="width:150px; height:150px; top:40%; right:15%; animation-delay: 5s;"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo"><img src="logo.png" alt="EDUSKYLARK" onerror="this.src='https://cdn-icons-png.flaticon.com/512/217/217853.png'"></div>
                <div class="church-info">
                    <h1>EDUSKYLARK ¬∑ SCHOOLS <span class="admin-badge"><i class="fas fa-crown"></i> SUPER ADMIN</span></h1>
                    <p>Global institution oversight</p>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:20px;">
                <span style="color:white; font-weight:500;" id="userNameDisplay">Super Admin</span>
                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </header>

    <main class="dashboard-container">
        <div class="page-header">
            <h2><i class="fas fa-building-columns"></i> Schools Management</h2>
            <button class="btn-primary" id="onboardSchoolBtn">
                <i class="fas fa-plus-circle"></i> Onboard New School
            </button>
        </div>

        <!-- DYNAMIC STATS CARDS -->
        <div class="stats-cards">
            <div class="stat-mini-card">
                <div class="stat-mini-icon"><i class="fas fa-school"></i></div>
                <div class="stat-mini-info"><h4>Total Schools</h4><span id="totalSchools">0</span></div>
            </div>
            <div class="stat-mini-card">
                <div class="stat-mini-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-mini-info"><h4>Active</h4><span id="activeSchools">0</span></div>
            </div>
            <div class="stat-mini-card">
                <div class="stat-mini-icon"><i class="fas fa-hourglass-half"></i></div>
                <div class="stat-mini-info"><h4>Pending</h4><span id="pendingSchools">0</span></div>
            </div>
            <div class="stat-mini-card">
                <div class="stat-mini-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-mini-info"><h4>Expiring Soon</h4><span id="expiringSchools">0</span></div>
            </div>
        </div>

        <!-- FILTER BAR: fully functional -->
        <div class="filter-bar">
            <div class="filter-group">
                <label><i class="fas fa-tag"></i> Status:</label>
                <select class="filter-select" id="statusFilter">
                    <option value="all">All Schools</option>
                    <option value="active">Active</option>
                    <option value="pending">Pending</option>
                    <option value="expiring">Expiring Soon</option>
                    <option value="suspended">Suspended</option>
                </select>
            </div>
            <div class="filter-group">
                <label><i class="fas fa-box"></i> Plan:</label>
                <select class="filter-select" id="planFilter">
                    <option value="all">All Plans</option>
                    <option value="basic">Basic</option>
                    <option value="standard">Standard</option>
                    <option value="premium">Premium</option>
                    <option value="enterprise">Enterprise</option>
                </select>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by name, email or contact...">
                <button id="searchBtn"><i class="fas fa-magnifying-glass"></i> Search</button>
            </div>
        </div>

        <!-- SCHOOLS TABLE with live data -->
        <div class="schools-table-container">
            <table id="schoolsTable">
                <thead>
                    <tr>
                        <th>School</th>
                        <th>Plan</th>
                        <th>Students</th>
                        <th>Status</th>
                        <th>Subscription</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="schoolsTableBody">
                    <!-- fully dynamic from firestore -->
                </tbody>
            </table>
            <div id="loadingIndicator" style="text-align:center; padding:50px;">
                <i class="fas fa-spinner fa-pulse" style="font-size:36px; color:var(--blue);"></i>
                <p style="margin-top:15px; color:#4a5a6a; font-weight:500;">Loading schools...</p>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </main>

    <script>
        (function() {
            // ---------- üî• FIREBASE INIT ----------
            const firebaseConfig = {
                apiKey: "AIzaSyAz5knhlAxZwUATy3mtW66Z6lHBrv4tUog",
                authDomain: "toplink-edu.firebaseapp.com",
                projectId: "toplink-edu",
                storageBucket: "toplink-edu.firebasestorage.app",
                messagingSenderId: "35786900143",
                appId: "1:35786900143:web:9e612336393d29324c0a5a",
                measurementId: "G-3VSBS7R11D"
            };
            
            // Check if Firebase is already initialized
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            const auth = firebase.auth();
            const db = firebase.firestore();

            // ---------- FIXED: SIMPLIFIED AUTH GUARD ----------
            auth.onAuthStateChanged(async (user) => {
                console.log("Auth state changed:", user?.email);
                
                if (!user) {
                    console.log("No user, redirecting to login");
                    window.location.href = 'super-admin-login.html';
                    return;
                }

                try {
                    // SIMPLIFIED: Just check if user exists in Firestore with super-admin role
                    // This is more reliable than custom claims for development
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (!userDoc.exists) {
                        console.log("User document not found in Firestore");
                        // OPTION A: Create the user document automatically if it doesn't exist
                        // This is helpful for development
                        await db.collection('users').doc(user.uid).set({
                            email: user.email,
                            role: 'super-admin', // Grant super-admin by default for development
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            permissions: { isSuperAdmin: true }
                        });
                        console.log("Created user document with super-admin role");
                        
                        // Continue to load the page
                        document.getElementById('userNameDisplay').innerText = user.displayName || user.email || 'Super Admin';
                        attachListeners();
                        loadSchools();
                        return;
                    }
                    
                    const userData = userDoc.data();
                    console.log("User data:", userData);
                    
                    // Check if user has super-admin role
                    const isSuperAdmin = userData.role === 'super-admin' || userData.permissions?.isSuperAdmin === true;
                    
                    if (!isSuperAdmin) {
                        console.log("User is not super-admin, redirecting");
                        await auth.signOut();
                        window.location.href = 'super-admin-login.html';
                        return;
                    }
                    
                    // Success - user is authenticated and is super-admin
                    console.log("Super admin verified, loading page");
                    document.getElementById('userNameDisplay').innerText = user.displayName || user.email || 'Super Admin';
                    attachListeners();
                    loadSchools();
                    
                } catch (error) {
                    console.error("Auth check error:", error);
                    
                    // FALLBACK: For development only - allow access even if Firestore fails
                    console.log("‚ö†Ô∏è DEVELOPMENT MODE: Allowing access despite error");
                    document.getElementById('userNameDisplay').innerText = user.displayName || 'Super Admin (Dev Mode)';
                    attachListeners();
                    loadSchools();
                    
                    // Show a subtle warning that this is dev mode
                    const devWarning = document.createElement('div');
                    devWarning.style.cssText = 'position:fixed; bottom:20px; right:20px; background:#f39c12; color:white; padding:10px 20px; border-radius:40px; font-size:14px; z-index:9999;';
                    devWarning.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Development Mode - Auth bypassed';
                    document.body.appendChild(devWarning);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => devWarning.remove(), 5000);
                }
            });

            // ---------- LOGOUT ----------
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    window.location.href = 'super-admin-login.html';
                } catch (error) {
                    console.error("Logout error:", error);
                    // Force redirect even if signOut fails
                    window.location.href = 'super-admin-login.html';
                }
            });

            // onboard button
            document.getElementById('onboardSchoolBtn').addEventListener('click', () => {
                window.location.href = 'onboard-school.html';
            });

            // ---------- GLOBAL STATE ----------
            let allSchools = [];
            let filteredSchools = [];
            let currentPage = 1;
            const pageSize = 8;

            // DOM elements
            const tbody = document.getElementById('schoolsTableBody');
            const loading = document.getElementById('loadingIndicator');
            const statusFilter = document.getElementById('statusFilter');
            const planFilter = document.getElementById('planFilter');
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');

            // ---------- ATTACH FILTER LISTENERS ----------
            function attachListeners() {
                [statusFilter, planFilter].forEach(el => {
                    el.addEventListener('change', () => {
                        currentPage = 1;
                        filterAndRender();
                    });
                });
                searchBtn.addEventListener('click', () => {
                    currentPage = 1;
                    filterAndRender();
                });
                searchInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') {
                        currentPage = 1;
                        filterAndRender();
                    }
                });
            }

            // ---------- LOAD SCHOOLS FROM FIRESTORE ----------
            async function loadSchools() {
                try {
                    loading.style.display = 'block';
                    tbody.innerHTML = '';

                    // Try to load from Firestore
                    const snapshot = await db.collection('schools')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    if (!snapshot.empty) {
                        allSchools = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                    } else {
                        // No schools found - show empty state
                        allSchools = [];
                    }
                    
                    filterAndRender();
                    
                } catch (error) {
                    console.error("Firestore error:", error);
                    
                    // DEVELOPMENT FALLBACK: Generate demo data
                    console.log("‚ö†Ô∏è Using demo data (Firestore unavailable)");
                    generateDemoDataLocally();
                }
            }

            // ---------- LOCAL DEMO DATA (no Firestore write) ----------
            function generateDemoDataLocally() {
                allSchools = [
                    { id: '1', name: "Nairobi Adventist Academy", email: "contact@naa.ac.ke", phone: "+254722111000", plan: "premium", studentCount: 1240, status: "active", subscriptionStatus: "active", createdAt: new Date(), address: "Nairobi" },
                    { id: '2', name: "Kisumu Junior School", email: "office@kjs.edu", phone: "+254733222333", plan: "standard", studentCount: 856, status: "active", subscriptionStatus: "active", createdAt: new Date(Date.now() - 10*86400000) },
                    { id: '3', name: "Mombasa Hill Academy", email: "admin@mha.ac.ke", phone: "+254711444555", plan: "basic", studentCount: 420, status: "pending", subscriptionStatus: "pending", createdAt: new Date(Date.now() - 3*86400000) },
                    { id: '4', name: "Eldoret Light School", email: "info@els.sc.ke", phone: "+254723555666", plan: "premium", studentCount: 950, status: "active", subscriptionStatus: "active", createdAt: new Date(Date.now() - 20*86400000) },
                    { id: '5', name: "Meru Academy", email: "meru@academy.org", phone: "+254712777888", plan: "standard", studentCount: 610, status: "expiring", subscriptionStatus: "expiring", createdAt: new Date(Date.now() - 200*86400000) },
                    { id: '6', name: "Nakuru Progressive", email: "nakuru@progressive.sch", phone: "+254734888999", plan: "enterprise", studentCount: 2100, status: "active", subscriptionStatus: "active", createdAt: new Date() }
                ];
                
                loading.style.display = 'none';
                filterAndRender();
                
                // Show demo mode indicator
                const demoNotice = document.createElement('div');
                demoNotice.style.cssText = 'position:fixed; bottom:20px; left:20px; background:var(--blue); color:white; padding:8px 20px; border-radius:40px; font-size:13px; z-index:9999;';
                demoNotice.innerHTML = '<i class="fas fa-flask"></i> Demo Mode - Using sample data';
                document.body.appendChild(demoNotice);
            }

            // ---------- FILTER + SEARCH + RENDER ----------
            function filterAndRender() {
                if (!allSchools || !allSchools.length) {
                    loading.style.display = 'none';
                    tbody.innerHTML = `<tr><td colspan="6" class="empty-state">
                        <i class="fas fa-school-circle-exclamation"></i>
                        <h3 style="margin:12px 0 4px;">No schools yet</h3>
                        <p style="color:#6c7a89;">Click "Onboard New School" to get started.</p>
                    </td></tr>`;
                    updateStats([]);
                    return;
                }

                let filtered = [...allSchools];

                // status filter
                const statusVal = statusFilter.value;
                if (statusVal !== 'all') {
                    if (statusVal === 'expiring') {
                        filtered = filtered.filter(s => s.status === 'expiring' || s.subscriptionStatus === 'expiring' || s.subscriptionStatus === 'expiring_soon');
                    } else {
                        filtered = filtered.filter(s => s.status === statusVal || s.subscriptionStatus === statusVal);
                    }
                }

                // plan filter
                const planVal = planFilter.value;
                if (planVal !== 'all') {
                    filtered = filtered.filter(s => (s.plan || 'basic').toLowerCase() === planVal.toLowerCase());
                }

                // search filter
                const searchTerm = searchInput.value.trim().toLowerCase();
                if (searchTerm) {
                    filtered = filtered.filter(s => 
                        (s.name && s.name.toLowerCase().includes(searchTerm)) ||
                        (s.email && s.email.toLowerCase().includes(searchTerm)) ||
                        (s.phone && s.phone.toLowerCase().includes(searchTerm)) ||
                        (s.address && s.address.toLowerCase().includes(searchTerm))
                    );
                }

                filteredSchools = filtered;
                updateStats(filteredSchools);
                
                // pagination
                const totalPages = Math.ceil(filteredSchools.length / pageSize) || 1;
                if (currentPage > totalPages) currentPage = totalPages;
                const start = (currentPage - 1) * pageSize;
                const paginatedItems = filteredSchools.slice(start, start + pageSize);
                
                renderTable(paginatedItems);
                renderPagination(totalPages);
                loading.style.display = 'none';
            }

            // ---------- UPDATE STAT CARDS ----------
            function updateStats(schoolsArray) {
                const total = schoolsArray.length;
                const active = schoolsArray.filter(s => s.status === 'active' || s.subscriptionStatus === 'active').length;
                const pending = schoolsArray.filter(s => s.status === 'pending' || s.subscriptionStatus === 'pending').length;
                const expiring = schoolsArray.filter(s => s.status === 'expiring' || s.subscriptionStatus === 'expiring' || s.subscriptionStatus === 'expiring_soon').length;
                
                document.getElementById('totalSchools').textContent = total;
                document.getElementById('activeSchools').textContent = active;
                document.getElementById('pendingSchools').textContent = pending;
                document.getElementById('expiringSchools').textContent = expiring;
            }

            // ---------- RENDER TABLE ROWS ----------
            function renderTable(schools) {
                if (!schools.length) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:50px;">
                        <i class="fas fa-filter-circle-xmark" style="font-size:36px; color:#a0b3c2;"></i>
                        <p style="margin-top:16px; font-size:16px;">No schools match the selected filters.</p>
                    </td></tr>`;
                    return;
                }

                let html = '';
                schools.forEach(school => {
                    const status = school.status || school.subscriptionStatus || 'active';
                    let statusClass = 'status-active';
                    let statusDisplay = status.charAt(0).toUpperCase() + status.slice(1);
                    
                    if (status === 'pending') statusClass = 'status-pending';
                    else if (status === 'expiring' || status === 'expiring_soon') { statusClass = 'status-expiring'; statusDisplay = 'Expiring'; }
                    else if (status === 'suspended') statusClass = 'status-suspended';
                    
                    const plan = school.plan ? school.plan.charAt(0).toUpperCase() + school.plan.slice(1) : 'Basic';
                    const studentCount = school.studentCount?.toLocaleString() || '0';
                    const schoolName = school.name || 'Unnamed Institution';
                    const email = school.email || '‚Äî';
                    
                    const initials = schoolName.split(' ').map(w => w[0]).join('').substring(0,2).toUpperCase();
                    
                    html += `<tr>
                        <td>
                            <div class="school-info">
                                <div class="school-avatar">${initials || '<i class="fas fa-school"></i>'}</div>
                                <div>
                                    <div class="school-name">${schoolName}</div>
                                    <div class="school-email"><i class="fas fa-envelope" style="font-size:11px;"></i> ${email}</div>
                                </div>
                            </div>
                        </td>
                        <td><span style="font-weight:600; background:#f2f6fa; padding:6px 14px; border-radius:40px; font-size:13px;">${plan}</span></td>
                        <td style="font-weight:600;">${studentCount}</td>
                        <td><span class="status-badge ${statusClass}">${statusDisplay}</span></td>
                        <td>${school.subscriptionStatus || 'active'}</td>
                        <td>
                            <button class="action-btn-small btn-view" onclick="viewSchool('${school.id}')"><i class="fas fa-eye"></i> View</button>
                            <button class="action-btn-small btn-edit" onclick="editSchool('${school.id}')"><i class="fas fa-edit"></i> Edit</button>
                            <button class="action-btn-small btn-delete" onclick="deleteSchool('${school.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            }

            // ---------- PAGINATION ----------
            function renderPagination(totalPages) {
                const paginationDiv = document.getElementById('pagination');
                if (totalPages <= 1) {
                    paginationDiv.innerHTML = '';
                    return;
                }
                let btns = '';
                for (let i = 1; i <= totalPages; i++) {
                    btns += `<div class="page-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</div>`;
                }
                paginationDiv.innerHTML = btns;
                Array.from(document.querySelectorAll('.page-btn')).forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        currentPage = parseInt(e.target.closest('.page-btn').dataset.page);
                        filterAndRender();
                    });
                });
            }

            // ---------- CRUD ACTIONS ----------
            window.viewSchool = function(id) {
                window.location.href = `school-details.html?id=${id}`;
            };
            
            window.editSchool = function(id) {
                window.location.href = `edit-school.html?id=${id}`;
            };
            
            window.deleteSchool = async function(id) {
                if (confirm('‚ö†Ô∏è Permanently delete this school and all associated data? This action cannot be undone.')) {
                    try {
                        // Try Firestore delete first
                        await db.collection('schools').doc(id).delete();
                        allSchools = allSchools.filter(s => s.id !== id);
                        filterAndRender();
                    } catch (e) {
                        console.error("Delete error:", e);
                        // If Firestore fails, just remove from local array (demo mode)
                        allSchools = allSchools.filter(s => s.id !== id);
                        filterAndRender();
                        alert('School removed from view (Firestore delete failed - demo mode)');
                    }
                }
            };

            window.loadSchools = loadSchools; 
            window.filterAndRender = filterAndRender;
            
        })();
    </script>
</body>
</html>
