<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDUSKYLARK · Staff</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --school-green: #27ae60;
            --school-green-dark: #229954;
            --dark-blue: #2c3e50;
            --white: #ffffff;
            --light-blue: #ecf0f1;
            --blue: #3498db;
            --orange: #e67e22;
            --red: #e74c3c;
            --purple: #9b59b6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #ecf0f1 0%, #d6dbdf 100%); min-height: 100vh; }
        .background-animation { position: fixed; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .bubble { position: absolute; border-radius: 50%; background: rgba(39,174,96,0.1); animation: float 15s infinite ease-in-out; }
        .bubble:nth-child(1) { width: 200px; height: 200px; top: 10%; left: 5%; animation-duration: 18s; }
        .bubble:nth-child(2) { width: 300px; height: 300px; bottom: 10%; right: 5%; animation-duration: 22s; background: rgba(230,126,34,0.08); }
        .bubble:nth-child(3) { width: 150px; height: 150px; top: 40%; right: 20%; animation-duration: 14s; }
        .bubble:nth-child(4) { width: 250px; height: 250px; bottom: 20%; left: 15%; animation-duration: 20s; background: rgba(52,152,219,0.08); }
        @keyframes float { 0%,100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-20px) scale(1.05); } }
        .header { background: linear-gradient(135deg, #2c3e50, #1a2530); color: white; padding: 20px 30px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; }
        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo { width: 60px; height: 60px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .logo img { width: 40px; height: 40px; object-fit: contain; }
        .church-info h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .church-info p { color: var(--school-green); font-size: 14px; }
        .school-badge { background: linear-gradient(135deg, var(--school-green), var(--school-green-dark)); color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px; margin-left: 10px; display: inline-block; }
        .dashboard-container { max-width: 1400px; margin: 30px auto; padding: 0 20px; animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
        }
        .page-header h2 { font-size: 28px; display: flex; align-items: center; gap: 15px; }
        .page-header h2 i { color: var(--school-green); }
        
        .stats-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; border-radius: 16px; padding: 25px; border-left: 5px solid var(--school-green);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-value { font-size: 36px; font-weight: 800; color: var(--dark-blue); }
        .stat-label { color: #7f8c8d; margin-top: 5px; font-weight: 500; }
        
        .filter-bar {
            background: white; border-radius: 16px; padding: 20px; margin-bottom: 30px;
            display: flex; flex-wrap: wrap; align-items: center; gap: 20px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.03);
        }
        .filter-select { 
            padding: 12px 25px; border: 2px solid #e9ecef; border-radius: 30px; background: white; 
            font-weight: 500; color: var(--dark-blue); cursor: pointer; outline: none;
        }
        .search-box {
            flex: 1; display: flex; align-items: center; background: #f9f9f9; border-radius: 30px;
            padding: 5px 5px 5px 20px; border: 2px solid #e9ecef; min-width: 280px;
        }
        .search-box input { flex: 1; padding: 12px 0; border: none; background: transparent; outline: none; font-size: 15px; }
        .search-box button {
            background: linear-gradient(135deg, var(--school-green), var(--school-green-dark));
            color: white; border: none; padding: 12px 25px; border-radius: 30px; cursor: pointer; font-weight: 600;
            transition: 0.2s; white-space: nowrap;
        }
        .search-box button:hover { opacity: 0.9; transform: scale(0.98); }
        
        .staff-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px;
        }
        .staff-card {
            background: white; border-radius: 20px; padding: 25px; display: flex; align-items: center; gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: all 0.3s; border-left: 5px solid var(--orange);
        }
        .staff-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        
        .staff-avatar {
            width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, var(--orange), #d35400);
            display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; font-weight: 700;
            text-transform: uppercase; flex-shrink: 0;
        }
        .staff-info { flex: 1; min-width: 0; }
        .staff-name { font-size: 20px; font-weight: 700; color: var(--dark-blue); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .staff-role { font-size: 14px; color: var(--orange); font-weight: 600; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.3px; }
        .staff-meta { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; font-size: 13px; color: #666; }
        .badge { padding: 4px 12px; border-radius: 30px; font-size: 12px; font-weight: 600; display: inline-block; }
        .badge-teacher { background: rgba(230,126,34,0.1); color: var(--orange); }
        .badge-department { background: rgba(52,152,219,0.1); color: var(--blue); }
        
        .btn-view {
            background: rgba(230,126,34,0.1); color: var(--orange); border: none;
            padding: 8px 20px; border-radius: 30px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-view:hover { background: var(--orange); color: white; }
        
        .add-btn {
            background: linear-gradient(135deg, var(--orange), #d35400);
            color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: 600;
            display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s; border: 2px solid transparent;
        }
        .add-btn:hover { opacity: 0.9; transform: scale(1.02); }

        .logout-btn {
            background: rgba(231,76,60,0.15); color: white; border: 2px solid var(--red); 
            padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: 600;
            transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .logout-btn:hover { background: var(--red); }

        /* Modal styles - improved with scrolling */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000;
            align-items: center; justify-content: center;
            overflow-y: auto; /* Enable vertical scrolling on modal backdrop */
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; border-radius: 30px; max-width: 550px; width: 100%; 
            padding: 30px; margin: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3); animation: modalSlide 0.3s ease-out;
            max-height: 90vh; /* Limit height to 90% of viewport */
            overflow-y: auto; /* Enable scrolling inside modal */
        }
        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
            position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 10px;
        }
        .modal-header h3 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .modal-close {
            font-size: 28px; cursor: pointer; color: #999; transition: 0.2s;
        }
        .modal-close:hover { color: var(--red); }
        
        .form-group { margin-bottom: 20px; }
        .form-label {
            display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark-blue);
        }
        .form-control {
            width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 12px;
            font-size: 15px; transition: 0.3s;
        }
        .form-control:focus {
            border-color: var(--orange); outline: none; box-shadow: 0 0 0 4px rgba(230,126,34,0.1);
        }
        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%232c3e50' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 18px center; background-size: 16px;
        }
        .modal-footer {
            display: flex; justify-content: flex-end; gap: 15px; margin-top: 25px;
            position: sticky; bottom: 0; background: white; padding-top: 15px;
        }
        .btn {
            padding: 14px 30px; border-radius: 30px; font-weight: 600; cursor: pointer; border: none;
            font-size: 16px; transition: 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--orange), #d35400);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(230,126,34,0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary {
            background: #f0f0f0; color: var(--dark-blue);
        }
        .btn-secondary:hover { background: #e0e0e0; }

        .empty-state { text-align: center; padding: 60px; background: white; border-radius: 30px; grid-column: 1 / -1; color: #95a5a6; }
        .empty-state i { font-size: 60px; margin-bottom: 20px; color: #d5dbdb; }
        
        .footer-note { margin-top: 40px; text-align: center; color: #7f8c8d; font-size: 14px; border-top: 1px solid rgba(0,0,0,0.05); padding: 20px; }

        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .error-message {
            background: rgba(231,76,60,0.1); color: var(--red); padding: 15px; border-radius: 12px;
            text-align: center; margin-bottom: 20px;
        }
        .small-note { color: #666; font-size: 12px; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo"><img src="https://cdn-icons-png.flaticon.com/512/217/217853.png" alt="EDUSKYLARK"></div>
                <div class="church-info">
                    <h1>EDUSKYLARK · STAFF <span class="school-badge"><i class="fas fa-school"></i> <span id="schoolNameHeader">SCHOOL ADMIN</span></span></h1>
                    <p>Manage Staff Records · <span id="schoolNameSub">Loading...</span></p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <span style="color: white; background: rgba(39,174,96,0.2); padding: 5px 15px; border-radius: 30px;">
                    <i class="fas fa-user-shield"></i> <span id="adminName">Admin</span>
                </span>
                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </header>

    <main class="dashboard-container">
        <div class="page-header">
            <h2><i class="fas fa-chalkboard-teacher"></i> Staff directory</h2>
            <button class="add-btn" id="addStaffBtn"><i class="fas fa-plus-circle"></i> Add staff</button>
        </div>

        <!-- Stats cards (filled dynamically) -->
        <div class="stats-cards" id="statsContainer">
            <div class="stat-card"><div class="stat-value" id="totalStaff">0</div><div class="stat-label">Total staff</div></div>
            <div class="stat-card"><div class="stat-value" id="totalTeachers">0</div><div class="stat-label">Teachers</div></div>
            <div class="stat-card"><div class="stat-value" id="totalAdmin">0</div><div class="stat-label">Admin</div></div>
            <div class="stat-card"><div class="stat-value" id="totalSupport">0</div><div class="stat-label">Support</div></div>
        </div>

        <!-- Filter bar -->
        <div class="filter-bar">
            <select class="filter-select" id="roleFilter">
                <option value="all">All roles</option>
                <option value="Teacher">Teacher</option>
                <option value="Admin">Admin</option>
                <option value="Support">Support staff</option>
            </select>
            <select class="filter-select" id="deptFilter">
                <option value="all">All departments</option>
                <option value="Mathematics">Mathematics</option>
                <option value="Science">Science</option>
                <option value="Languages">Languages</option>
                <option value="Humanities">Humanities</option>
                <option value="Administration">Administration</option>
                <option value="Maintenance">Maintenance</option>
                <option value="IT">IT</option>
            </select>
            <div class="search-box">
                <input type="text" placeholder="Search by name or email..." id="searchInput">
                <button id="searchBtn"><i class="fas fa-search"></i> Search</button>
            </div>
        </div>

        <!-- Staff grid -->
        <div class="staff-grid" id="staffGrid"></div>
        <div class="footer-note">EDUSKYLARK · staff management · realtime firestore</div>
    </main>

    <!-- Add Staff Modal - Scrollable -->
    <div class="modal" id="staffModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus" style="color: var(--orange);"></i> Add New Staff</h3>
                <span class="modal-close" id="closeModal">&times;</span>
            </div>
            <form id="staffForm">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="staffName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email * (will receive login credentials)</label>
                    <input type="email" class="form-control" id="staffEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Temporary Password *</label>
                    <input type="password" class="form-control" id="staffPassword" value="Staff123!" required>
                    <div class="small-note"><i class="fas fa-info-circle"></i> Min 6 characters. User can change after first login.</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone *</label>
                    <input type="tel" class="form-control" id="staffPhone" placeholder="+254 712 345 678" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Role *</label>
                    <select class="form-control" id="staffRole" required>
                        <option value="">Select Role</option>
                        <option value="Teacher">Teacher</option>
                        <option value="Admin">Admin</option>
                        <option value="Support">Support staff</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Department *</label>
                    <select class="form-control" id="staffDept" required>
                        <option value="">Select Department</option>
                        <option value="Mathematics">Mathematics</option>
                        <option value="Science">Science</option>
                        <option value="Languages">Languages</option>
                        <option value="Humanities">Humanities</option>
                        <option value="Administration">Administration</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="IT">IT</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelModal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveStaffBtn">Add Staff</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAz5knhlAxZwUATy3mtW66Z6lHBrv4tUog",
            authDomain: "toplink-edu.firebaseapp.com",
            projectId: "toplink-edu",
            storageBucket: "toplink-edu.firebasestorage.app",
            messagingSenderId: "35786900143",
            appId: "1:35786900143:web:9e612336393d29324c0a5a",
            measurementId: "G-3VSBS7R11D"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ========== DOM ELEMENTS ==========
        const schoolNameHeader = document.getElementById('schoolNameHeader');
        const schoolNameSub = document.getElementById('schoolNameSub');
        const adminName = document.getElementById('adminName');
        const logoutBtn = document.getElementById('logoutBtn');
        const addStaffBtn = document.getElementById('addStaffBtn');
        const staffGrid = document.getElementById('staffGrid');
        
        // Stats elements
        const totalStaffSpan = document.getElementById('totalStaff');
        const totalTeachersSpan = document.getElementById('totalTeachers');
        const totalAdminSpan = document.getElementById('totalAdmin');
        const totalSupportSpan = document.getElementById('totalSupport');
        
        // Filter elements
        const roleFilter = document.getElementById('roleFilter');
        const deptFilter = document.getElementById('deptFilter');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        
        // Modal elements
        const staffModal = document.getElementById('staffModal');
        const closeModal = document.getElementById('closeModal');
        const cancelModal = document.getElementById('cancelModal');
        const staffForm = document.getElementById('staffForm');
        const saveStaffBtn = document.getElementById('saveStaffBtn');

        // ========== STATE ==========
        let currentUser = null;
        let adminData = null;
        let schoolIdentifier = null;
        let allStaff = [];
        let filteredStaff = [];

        // ========== AUTH STATE LISTENER ==========
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadAdminData(user);
                if (!adminData) {
                    showError('No admin record found. Please contact super admin.');
                    return;
                }
                if (adminData.status !== 'Active') {
                    alert('Your account is not active. Please contact super admin.');
                    await auth.signOut();
                    return;
                }
                updateUI();
                
                // Determine school identifier
                if (adminData.schoolId) {
                    schoolIdentifier = { type: 'schoolId', value: adminData.schoolId };
                } else if (adminData.school) {
                    schoolIdentifier = { type: 'school', value: adminData.school };
                } else {
                    showError('No school information found in your admin profile.');
                    return;
                }
                
                // Set up real-time listener for staff
                setupStaffListener();
            } else {
                window.location.href = 'school-admin-login.html';
            }
        });

        // ========== LOAD ADMIN DATA ==========
        async function loadAdminData(user) {
            try {
                const adminsQuery = await db.collection('admins')
                    .where('authUid', '==', user.uid)
                    .limit(1)
                    .get();

                if (!adminsQuery.empty) {
                    adminData = adminsQuery.docs[0].data();
                    adminData.id = adminsQuery.docs[0].id;
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        // ========== UPDATE UI ==========
        function updateUI() {
            if (!adminData) return;
            const fullName = adminData.name || 'School Administrator';
            adminName.textContent = fullName.split(' ')[0] || 'Admin';
            const schoolName = adminData.school || 'Your School';
            schoolNameHeader.textContent = schoolName;
            schoolNameSub.textContent = schoolName;
        }

        // ========== SETUP STAFF LISTENER ==========
        function setupStaffListener() {
            if (!schoolIdentifier) return;

            let query;
            if (schoolIdentifier.type === 'schoolId') {
                query = db.collection('staff').where('schoolId', '==', schoolIdentifier.value);
            } else {
                query = db.collection('staff').where('school', '==', schoolIdentifier.value);
            }

            query.onSnapshot(snapshot => {
                allStaff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyFilters();
            }, error => {
                console.error('Firestore error:', error);
                // Show empty state
                renderEmpty();
            });
        }

        // ========== FILTER & RENDER ==========
        function applyFilters() {
            const role = roleFilter.value;
            const dept = deptFilter.value;
            const query = searchInput.value.trim().toLowerCase();

            filteredStaff = allStaff.filter(s => {
                if (role !== 'all' && s.role !== role) return false;
                if (dept !== 'all' && s.department !== dept) return false;
                if (query) {
                    return s.name?.toLowerCase().includes(query) || 
                           s.email?.toLowerCase().includes(query) ||
                           s.phone?.includes(query);
                }
                return true;
            });

            updateStats();
            renderStaffGrid();
        }

        function updateStats() {
            totalStaffSpan.textContent = filteredStaff.length;
            const teachers = filteredStaff.filter(s => s.role === 'Teacher').length;
            const admins = filteredStaff.filter(s => s.role === 'Admin').length;
            const support = filteredStaff.filter(s => s.role === 'Support').length;
            totalTeachersSpan.textContent = teachers;
            totalAdminSpan.textContent = admins;
            totalSupportSpan.textContent = support;
        }

        function renderStaffGrid() {
            if (filteredStaff.length === 0) {
                staffGrid.innerHTML = `<div class="empty-state"><i class="fas fa-user-slash"></i><h3>No staff found</h3><p>Try adjusting filters or add a new staff member.</p></div>`;
                return;
            }

            let html = '';
            filteredStaff.forEach(s => {
                const initials = s.name ? s.name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase() : 'ST';
                html += `
                    <div class="staff-card" data-id="${s.id}">
                        <div class="staff-avatar">${initials}</div>
                        <div class="staff-info">
                            <div class="staff-name">${s.name || 'Unnamed'}</div>
                            <div class="staff-role"><i class="fas fa-tag"></i> ${s.role || 'Staff'}</div>
                            <div class="staff-meta">
                                <span><i class="fas fa-building"></i> ${s.department || '—'}</span>
                                <span><i class="fas fa-envelope"></i> ${s.email || '—'}</span>
                            </div>
                            <div style="margin-top: 12px;">
                                <span class="badge badge-teacher">${s.role || 'Staff'}</span>
                                <span class="badge badge-department"><i class="fas fa-phone"></i> ${s.phone || '—'}</span>
                            </div>
                        </div>
                        <button class="btn-view view-profile" data-id="${s.id}"><i class="fas fa-eye"></i> View</button>
                    </div>
                `;
            });
            staffGrid.innerHTML = html;

            // Attach view profile handlers
            document.querySelectorAll('.view-profile').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = btn.dataset.id;
                    alert(`View profile for staff ID: ${id} (detail page would open)`);
                });
            });
        }

        function renderEmpty() {
            staffGrid.innerHTML = `<div class="empty-state"><i class="fas fa-user-slash"></i><h3>No staff found</h3><p>Add your first staff member using the button above.</p></div>`;
        }

        // ========== MODAL HANDLING ==========
        addStaffBtn.addEventListener('click', () => {
            staffModal.classList.add('active');
        });

        closeModal.addEventListener('click', () => {
            staffModal.classList.remove('active');
            staffForm.reset();
        });

        cancelModal.addEventListener('click', () => {
            staffModal.classList.remove('active');
            staffForm.reset();
        });

        window.addEventListener('click', (e) => {
            if (e.target === staffModal) {
                staffModal.classList.remove('active');
                staffForm.reset();
            }
        });

        // ========== ADD STAFF FORM SUBMISSION ==========
        staffForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            saveStaffBtn.disabled = true;
            saveStaffBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

            try {
                // Validate inputs
                const name = document.getElementById('staffName').value.trim();
                const email = document.getElementById('staffEmail').value.trim();
                const password = document.getElementById('staffPassword').value;
                const phone = document.getElementById('staffPhone').value.trim();
                const role = document.getElementById('staffRole').value;
                const department = document.getElementById('staffDept').value;

                if (!name || !email || !password || !phone || !role || !department) {
                    throw new Error('Please fill all required fields');
                }
                if (password.length < 6) {
                    throw new Error('Password must be at least 6 characters');
                }

                // 1. Create Firebase Auth user
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const firebaseUser = userCredential.user;

                // 2. Send verification email instead of password reset
                await firebaseUser.sendEmailVerification({
                    url: window.location.origin + '/staff-login.html',
                    handleCodeInApp: true
                });

                // 3. Prepare staff data
                const staffData = {
                    name: name,
                    email: email,
                    phone: phone,
                    role: role,
                    department: department,
                    authUid: firebaseUser.uid,
                    emailVerified: firebaseUser.emailVerified,
                    status: 'Active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Add school identifier
                if (schoolIdentifier.type === 'schoolId') {
                    staffData.schoolId = schoolIdentifier.value;
                } else {
                    staffData.school = schoolIdentifier.value;
                }

                // 4. Save to Firestore
                await db.collection('staff').add(staffData);

                // 5. Close modal and reset
                staffModal.classList.remove('active');
                staffForm.reset();
                alert('✅ Staff added successfully! Verification email sent.');

            } catch (error) {
                console.error('Error adding staff:', error);
                
                // Handle specific Firebase Auth errors
                let errorMessage = error.message;
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already in use. Please use a different email.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Please enter a valid email address.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password should be at least 6 characters.';
                }
                
                alert('❌ Error: ' + errorMessage);
            } finally {
                saveStaffBtn.disabled = false;
                saveStaffBtn.innerHTML = 'Add Staff';
            }
        });

        // ========== EVENT LISTENERS ==========
        roleFilter.addEventListener('change', applyFilters);
        deptFilter.addEventListener('change', applyFilters);
        searchBtn.addEventListener('click', applyFilters);
        searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') applyFilters(); });

        logoutBtn.addEventListener('click', async () => {
            await auth.signOut();
            window.location.href = 'school-login.html';
        });

        // Fallback timeout for empty data
        setTimeout(() => {
            if (allStaff.length === 0) {
                renderEmpty();
                totalStaffSpan.textContent = '0';
                totalTeachersSpan.textContent = '0';
                totalAdminSpan.textContent = '0';
                totalSupportSpan.textContent = '0';
            }
        }, 5000);

        // Helper function for error display
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            document.querySelector('.dashboard-container').prepend(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }
    </script>
</body>
</html>
