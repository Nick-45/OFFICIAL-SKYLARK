<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDUSKYLARK Â· Class Profile (upgraded)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK (compat) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: #f0f4f8; min-height: 100vh; display: flex; flex-direction: column; }
        /* animated background */
        .bg-flow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2; overflow: hidden;
            background: linear-gradient(145deg, #d4eaf2 0%, #f1f9ff 100%);
        }
        .bg-flow::before {
            content: ''; position: absolute; width: 200%; height: 200%;
            top: -50%; left: -50%;
            background: radial-gradient(circle at 30% 40%, rgba(46, 204, 113, 0.15) 0%, transparent 30%),
                        radial-gradient(circle at 70% 80%, rgba(52, 152, 219, 0.12) 0%, transparent 35%),
                        radial-gradient(circle at 10% 70%, rgba(155, 89, 182, 0.1) 0%, transparent 40%);
            animation: rotate 60s linear infinite;
        }
        @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        :root {
            --primary: #1abc9c; --primary-dark: #16a085;
            --secondary: #2c3e50; --accent: #f39c12;
            --light: #ecf0f1; --danger: #e74c3c; --success: #27ae60;
            --gray: #7f8c8d; --border: #e2e8f0;
        }
        .header {
            background: rgba(44, 62, 80, 0.98); backdrop-filter: blur(8px);
            color: white; padding: 18px 32px; box-shadow: 0 12px 30px rgba(0,0,0,0.15);
            position: sticky; top: 0; z-index: 50;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; }
        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo { width: 52px; height: 52px; background: white; border-radius: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
        .church-info h1 { font-size: 1.8rem; font-weight: 600; letter-spacing: -0.5px; display: flex; align-items: center; gap: 12px; }
        .school-badge { background: var(--primary); padding: 6px 16px; border-radius: 40px; font-size: 0.9rem; font-weight: 500; }
        .admin-profile { display: flex; align-items: center; gap: 20px; }
        .admin-tag { background: rgba(255,255,255,0.12); padding: 8px 18px; border-radius: 40px; font-weight: 500; backdrop-filter: blur(4px); }
        .logout-btn { background: rgba(231, 76, 60, 0.15); border: 1.5px solid var(--danger); color: white; padding: 10px 22px; border-radius: 40px; font-weight: 600; transition: 0.3s; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .logout-btn:hover { background: var(--danger); transform: scale(1.02); box-shadow: 0 10px 20px rgba(231,76,60,0.4); }

        .dashboard-container { max-width: 1300px; margin: 30px auto; padding: 0 30px; flex: 1; }
        .page-header { margin-bottom: 30px; }
        .page-header h2 { font-size: 2rem; color: var(--secondary); display: flex; align-items: center; gap: 15px; }

        /* class hero */
        .class-hero {
            background: linear-gradient(135deg, #0f766e, #149079);
            border-radius: 36px; padding: 40px 45px; color: white; margin-bottom: 35px;
            box-shadow: 0 30px 40px -15px rgba(26,188,156,0.5);
            position: relative; isolation: isolate;
        }
        .class-hero::after {
            content: ''; position: absolute; inset: 0; border-radius: 36px;
            background: radial-gradient(circle at 100% 0%, rgba(255,255,255,0.2) 0%, transparent 50%);
            z-index: -1;
        }
        .class-title { font-size: 3.5rem; font-weight: 800; line-height: 1.1; margin-bottom: 8px; text-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        .class-desc { font-size: 1.2rem; opacity: 0.9; margin-bottom: 25px; display: flex; align-items: center; gap: 8px; }
        .meta-grid { display: flex; flex-wrap: wrap; gap: 20px; }
        .meta-pill {
            background: rgba(255,255,255,0.15); backdrop-filter: blur(8px); padding: 16px 28px; border-radius: 50px;
            display: flex; align-items: center; gap: 18px; border: 1px solid rgba(255,255,255,0.3);
            transition: 0.2s; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .meta-pill i { font-size: 2rem; opacity: 0.9; }
        .meta-pill strong { font-size: 1.8rem; font-weight: 700; display: block; line-height: 1.2; }

        .action-bar { display: flex; gap: 18px; margin-bottom: 35px; flex-wrap: wrap; }
        .btn {
            padding: 14px 30px; border-radius: 40px; font-weight: 600; border: none; cursor: pointer;
            display: inline-flex; align-items: center; gap: 12px; font-size: 1rem;
            transition: all 0.2s; box-shadow: 0 8px 18px rgba(0,0,0,0.05);
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-3px); box-shadow: 0 15px 25px rgba(26,188,156,0.35); }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }
        .btn-soft { background: white; color: var(--secondary); border: 1px solid var(--border); }
        .btn-soft:hover { background: #f8fafc; border-color: var(--primary); }

        .profile-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; align-items: start; }

        .card {
            background: rgba(255,255,255,0.9); backdrop-filter: blur(12px);
            border-radius: 32px; padding: 30px; box-shadow: 0 15px 35px -8px rgba(0,20,10,0.15);
            border: 1px solid rgba(255,255,255,0.7); margin-bottom: 30px;
        }
        .card-title { font-size: 1.5rem; font-weight: 700; color: var(--secondary); margin-bottom: 22px; display: flex; align-items: center; gap: 12px; border-left: 6px solid var(--primary); padding-left: 18px; }

        /* schedule */
        .schedule-table { width: 100%; border-collapse: collapse; }
        .schedule-table th { text-align: left; padding: 16px 0 8px; color: var(--gray); font-weight: 600; border-bottom: 2px solid #dee7ed; }
        .schedule-table td { padding: 14px 0; border-bottom: 1px solid #eef3f6; }
        .day-badge { background: rgba(26,188,156,0.12); color: var(--primary-dark); padding: 6px 16px; border-radius: 30px; font-weight: 600; font-size: 0.9rem; }

        /* student items */
        .student-item {
            display: flex; align-items: center; gap: 15px; padding: 14px 0;
            border-bottom: 1px solid #e9edf2;
        }
        .student-avatar-sm {
            width: 48px; height: 48px; border-radius: 24px;
            background: linear-gradient(145deg, var(--primary), #0e8d73);
            display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1rem;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .student-info-sm { flex: 1; }
        .student-name-sm { font-weight: 700; color: #1e293b; }
        .student-meta-sm { font-size: 0.85rem; color: #475569; display: flex; gap: 20px; margin-top: 4px; }

        .teacher-card {
            background: #f1f9f6; border-radius: 24px; padding: 24px;
            display: flex; align-items: center; gap: 22px; border: 1px solid #d0f0e5;
        }
        .teacher-avatar { width: 70px; height: 70px; border-radius: 35px; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; }

        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .detail-item { background: #f8fafc; padding: 15px 18px; border-radius: 22px; }
        .detail-label { color: var(--gray); font-size: 0.9rem; margin-bottom: 6px; }
        .detail-value { font-size: 1.3rem; font-weight: 700; color: var(--secondary); }

        .empty-state { text-align: center; padding: 40px 20px; background: #f1f5f9; border-radius: 24px; color: #64748b; }
        .badge { background: var(--primary); color: white; padding: 6px 18px; border-radius: 30px; font-size: 0.9rem; }

        @media (max-width: 800px) { .profile-grid { grid-template-columns: 1fr; } .class-title { font-size: 2.5rem; } }
    </style>
</head>
<body>
<div class="bg-flow"></div>

<header class="header">
    <div class="header-content">
        <div class="logo-section">
            <div class="logo"><i class="fas fa-graduation-cap fa-2x" style="color: var(--primary);"></i></div>
            <div class="church-info">
                <h1>EDUSKYLARK Â· <span style="font-weight: 300;">class profile</span> <span class="school-badge"><i class="fas fa-school"></i> <span id="schoolNameHeader">â€‘â€‘</span></span></h1>
                <p style="opacity: 0.8;"><span id="schoolNameSub">â€‘â€‘</span> Â· class overview</p>
            </div>
        </div>
        <div class="admin-profile">
            <span class="admin-tag"><i class="fas fa-user-shield"></i> <span id="adminName">Admin</span></span>
            <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </div>
</header>

<main class="dashboard-container">
    <!-- header back & actions -->
    <div class="page-header">
        <h2><i class="fas fa-address-card" style="color: var(--primary);"></i> Class profile Â· <span id="classNameBreadcrumb">â€‘â€‘</span></h2>
    </div>

    <!-- class hero dynamically populated -->
    <div class="class-hero" id="classHero">
        <div class="class-title" id="classNameDisplay">â€‘â€‘</div>
        <div class="class-desc"><i class="fas fa-tag"></i> <span id="classGradeDisplay">â€‘â€‘</span> Â· <span id="classStreamDesc">â€‘â€‘</span></div>
        <div class="meta-grid" id="classMetaGrid"></div>
    </div>

    <!-- action row -->
    <div class="action-bar">
        <button class="btn btn-primary" id="editClassBtn"><i class="fas fa-edit"></i> Edit class</button>
        <button class="btn btn-outline" id="attendanceBtn"><i class="fas fa-calendar-check"></i> Take attendance</button>
        <button class="btn btn-soft" id="backBtn"><i class="fas fa-arrow-left"></i> All classes</button>
    </div>

    <!-- main grid -->
    <div class="profile-grid">
        <!-- left wide column -->
        <div>
            <!-- schedule card -->
            <div class="card">
                <div class="card-title"><i class="fas fa-calendar-alt"></i> Weekly schedule</div>
                <div id="scheduleWrapper">
                    <table class="schedule-table" id="scheduleTable">
                        <thead><tr><th>Day</th><th>Subject</th><th>Time</th></tr></thead>
                        <tbody id="scheduleBody"></tbody>
                    </table>
                    <div id="noScheduleMsg" class="empty-state" style="display: none; margin-top: 20px;">
                        <i class="fas fa-calendar-times fa-2x"></i> <p>No timetable yet</p>
                    </div>
                </div>
            </div>

            <!-- students enrolled card -->
            <div class="card">
                <div class="card-title" style="justify-content: space-between;">
                    <span><i class="fas fa-users"></i> Students enrolled</span>
                    <span class="badge" id="studentCountBadge">0</span>
                </div>
                <div id="studentsList" class="students-container">
                    <!-- dynamic injected -->
                </div>
            </div>
        </div>

        <!-- right sidebar -->
        <div>
            <!-- class teacher -->
            <div class="card">
                <div class="card-title"><i class="fas fa-chalkboard-teacher"></i> Class teacher</div>
                <div id="teacherContainer"></div>
            </div>

            <!-- class details card (elevated) -->
            <div class="card">
                <div class="card-title"><i class="fas fa-info-circle"></i> Class details</div>
                <div class="detail-grid">
                    <div class="detail-item"><span class="detail-label"><i class="far fa-door-open"></i> Room</span><div class="detail-value" id="roomDisplay">â€”</div></div>
                    <div class="detail-item"><span class="detail-label"><i class="fas fa-people-arrows"></i> Capacity</span><div class="detail-value" id="capacityDisplay">â€”</div></div>
                    <div class="detail-item"><span class="detail-label"><i class="fas fa-calendar"></i> Academic year</span><div class="detail-value" id="yearDisplay">â€”</div></div>
                    <div class="detail-item"><span class="detail-label"><i class="fas fa-layer-group"></i> Grade</span><div class="detail-value" id="gradeDisplay">â€”</div></div>
                </div>
                <div style="margin-top: 20px; display: flex; align-items: center; justify-content: space-between;">
                    <span class="detail-label">Status</span>
                    <span id="statusDisplay" class="badge" style="background: rgba(39,174,96,0.15); color: #1e7e4a; font-weight: 600;">Active</span>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // ========== CONFIG ==========
    const firebaseConfig = {
        apiKey: "AIzaSyAz5knhlAxZwUATy3mtW66Z6lHBrv4tUog",
        authDomain: "toplink-edu.firebaseapp.com",
        projectId: "toplink-edu",
        storageBucket: "toplink-edu.firebasestorage.app",
        messagingSenderId: "35786900143",
        appId: "1:35786900143:web:9e612336393d29324c0a5a"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ---------- DOM elements ----------
    const schoolNameHeader = document.getElementById('schoolNameHeader');
    const schoolNameSub = document.getElementById('schoolNameSub');
    const adminNameSpan = document.getElementById('adminName');
    const logoutBtn = document.getElementById('logoutBtn');
    const classNameDisplay = document.getElementById('classNameDisplay');
    const classGradeDisplay = document.getElementById('classGradeDisplay');
    const classStreamDesc = document.getElementById('classStreamDesc');
    const classMetaGrid = document.getElementById('classMetaGrid');
    const scheduleBody = document.getElementById('scheduleBody');
    const noScheduleMsg = document.getElementById('noScheduleMsg');
    const studentsList = document.getElementById('studentsList');
    const studentCountBadge = document.getElementById('studentCountBadge');
    const teacherContainer = document.getElementById('teacherContainer');
    const roomDisplay = document.getElementById('roomDisplay');
    const capacityDisplay = document.getElementById('capacityDisplay');
    const yearDisplay = document.getElementById('yearDisplay');
    const gradeDisplay = document.getElementById('gradeDisplay');
    const statusDisplay = document.getElementById('statusDisplay');
    const editClassBtn = document.getElementById('editClassBtn');
    const attendanceBtn = document.getElementById('attendanceBtn');
    const backBtn = document.getElementById('backBtn');
    const classNameBreadcrumb = document.getElementById('classNameBreadcrumb');

    // ---------- state ----------
    let currentUser = null, adminData = null, classId = null, classData = null;

    // ---------- auth ----------
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            await loadAdminData(user);
            if (!adminData) { alert('Admin not found'); auth.signOut(); window.location = 'school-login.html'; return; }
            if (adminData.status !== 'Active') { alert('Account inactive'); auth.signOut(); window.location = 'school-login.html'; return; }
            updateUI();

            const urlParams = new URLSearchParams(window.location.search);
            classId = urlParams.get('id') || sessionStorage.getItem('viewClassId');
            if (!classId) { alert('No class selected'); window.location = 'school-classes.html'; return; }

            await loadClassData();
        } else {
            window.location = 'school-login.html';
        }
    });

    async function loadAdminData(user) {
        try {
            const snap = await db.collection('admins').where('authUid', '==', user.uid).limit(1).get();
            if (!snap.empty) { adminData = snap.docs[0].data(); adminData.id = snap.docs[0].id; }
        } catch (e) { console.warn('admin fetch fail', e); }
    }

    function updateUI() {
        if (!adminData) return;
        adminNameSpan.textContent = adminData.name ? adminData.name.split(' ')[0] : 'Admin';
        const school = adminData.school || adminData.schoolName || 'My School';
        schoolNameHeader.textContent = school;
        schoolNameSub.textContent = school;
    }

    // ---------- load class ----------
    async function loadClassData() {
        try {
            const doc = await db.collection('classes').doc(classId).get();
            if (!doc.exists) throw new Error('class missing');
            classData = { id: doc.id, ...doc.data() };

            const classSchool = classData.schoolId || classData.school;
            const adminSchool = adminData.schoolId || adminData.school;
            if (classSchool !== adminSchool) { alert('permission denied'); window.location = 'school-classes.html'; return; }

            renderClass();
            loadStudents();
        } catch (err) {
            console.warn('using fallback mock data');
            loadMockClass();
        }
    }

    function renderClass() {
        if (!classData) return;
        classNameDisplay.textContent = classData.name || 'Form X';
        classNameBreadcrumb.textContent = classData.name || 'class';
        const grade = classData.grade || classData.gradeLevel || 'â€”';
        classGradeDisplay.textContent = grade;
        classStreamDesc.textContent = classData.stream || classData.description || 'Main stream';

        const studentCount = classData.studentCount || (classData.students?.length) || 0;
        const capacity = classData.capacity || 'â€”';
        const teacher = classData.teacherName || 'unassigned';
        classMetaGrid.innerHTML = `
            <div class="meta-pill"><i class="fas fa-users"></i><span><strong>${studentCount}</strong> Students</span></div>
            <div class="meta-pill"><i class="fas fa-door-open"></i><span><strong>${capacity}</strong> Capacity</span></div>
            <div class="meta-pill"><i class="fas fa-user-tie"></i><span><strong>${teacher}</strong> Teacher</span></div>
        `;

        // schedule
        if (classData.schedule && classData.schedule.length) {
            let html = '';
            classData.schedule.forEach(s => {
                html += `<tr><td><span class="day-badge">${s.day || 'â€”'}</span></td><td>${s.subject || 'â€”'}</td><td>${s.startTime || '??'} â€“ ${s.endTime || '??'}</td></tr>`;
            });
            scheduleBody.innerHTML = html;
            noScheduleMsg.style.display = 'none';
        } else {
            scheduleBody.innerHTML = '';
            noScheduleMsg.style.display = 'block';
        }

        // teacher area
        if (classData.teacherName) {
            teacherContainer.innerHTML = `
                <div class="teacher-card">
                    <div class="teacher-avatar"><i class="fas fa-user-graduate"></i></div>
                    <div><h3 style="font-size:1.5rem;">${classData.teacherName}</h3><p style="color: #2c3e50;"><i class="fas fa-envelope"></i> ${classData.teacherEmail || 'teacher@school.com'}</p><span style="background: #d0f0e5; padding:4px 14px; border-radius:40px;">class teacher</span></div>
                </div>
            `;
        } else {
            teacherContainer.innerHTML = `<div class="empty-state"><i class="fas fa-user-slash"></i> <p>No teacher assigned</p></div>`;
        }

        roomDisplay.textContent = classData.room || 'â€”';
        capacityDisplay.textContent = classData.capacity || 'â€”';
        yearDisplay.textContent = classData.academicYear || new Date().getFullYear();
        gradeDisplay.textContent = grade;
        statusDisplay.textContent = classData.status || 'Active';
        statusDisplay.style.background = classData.status === 'Active' ? 'rgba(39,174,96,0.15)' : 'rgba(231,76,60,0.15)';
        statusDisplay.style.color = classData.status === 'Active' ? '#1e7e4a' : '#c0392b';
    }

    async function loadStudents() {
        if (!classData || !classData.name) return;
        try {
            const q = await db.collection('students').where('class', '==', classData.name).limit(15).get();
            if (!q.empty) {
                let html = '';
                q.forEach(doc => {
                    const s = doc.data();
                    const initials = s.fullName ? s.fullName.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2) : 'ST';
                    html += `<div class="student-item">
                        <div class="student-avatar-sm">${initials}</div>
                        <div class="student-info-sm">
                            <div class="student-name-sm">${s.fullName || 'Student'}</div>
                            <div class="student-meta-sm"><span><i class="fas fa-hashtag"></i> ${s.admissionNo || 'â€”'}</span><span><i class="fas fa-phone-alt"></i> ${s.phone || 'â€”'}</span></div>
                        </div>
                        <button class="btn" style="padding:6px 14px;" onclick="viewStudent('${doc.id}')"><i class="fas fa-eye"></i></button>
                    </div>`;
                });
                studentsList.innerHTML = html;
                studentCountBadge.textContent = q.size;
            } else {
                studentsList.innerHTML = `<div class="empty-state"><i class="fas fa-user-graduate"></i> <p>No students yet</p></div>`;
                studentCountBadge.textContent = '0';
            }
        } catch (e) {
            loadMockStudents();
        }
    }

    // mocks
    function loadMockClass() {
        classData = {
            id: 'mockC',
            name: 'Form 3C',
            grade: 'Form 3',
            stream: 'Science',
            teacherName: 'Mr. John Mwangi',
            teacherEmail: 'j.mwangi@eduskylark.sch',
            studentCount: 42,
            capacity: 45,
            room: 'Lab 204',
            academicYear: '2025',
            status: 'Active',
            schedule: [
                { day: 'Monday', subject: 'Mathematics', startTime: '08:00', endTime: '09:30' },
                { day: 'Tuesday', subject: 'Physics', startTime: '10:00', endTime: '11:30' },
                { day: 'Wednesday', subject: 'Chemistry', startTime: '08:00', endTime: '09:30' },
                { day: 'Thursday', subject: 'Biology', startTime: '13:00', endTime: '14:30' },
                { day: 'Friday', subject: 'English', startTime: '09:00', endTime: '10:30' }
            ]
        };
        renderClass();
        loadMockStudents();
    }

    function loadMockStudents() {
        const m = [
            { fullName: 'John Mwangi', admissionNo: '2025-001', phone: '+254722111222' },
            { fullName: 'Mary Atieno', admissionNo: '2025-042', phone: '+254733333444' },
            { fullName: 'Peter Kamau', admissionNo: '2024-128', phone: '+254711555666' },
            { fullName: 'Alice Odhiambo', admissionNo: '2023-215', phone: '+254722777888' }
        ];
        let html = '';
        m.forEach(s => {
            const ini = s.fullName.split(' ').map(n=>n[0]).join('').toUpperCase();
            html += `<div class="student-item"><div class="student-avatar-sm">${ini}</div><div class="student-info-sm"><div class="student-name-sm">${s.fullName}</div><div class="student-meta-sm"><span><i class="fas fa-hashtag"></i> ${s.admissionNo}</span><span><i class="fas fa-phone-alt"></i> ${s.phone}</span></div></div><button class="btn" style="padding:6px 14px;" onclick="viewStudent('mock')"><i class="fas fa-eye"></i></button></div>`;
        });
        studentsList.innerHTML = html;
        studentCountBadge.textContent = m.length;
    }

    window.viewStudent = function(id) {
        sessionStorage.setItem('viewStudentId', id);
        window.location.href = `school-student-details.html?id=${id}`;
    };

    // navigation
    logoutBtn.addEventListener('click', async () => { await auth.signOut(); window.location = 'school-login.html'; });
    editClassBtn.addEventListener('click', () => alert('âœï¸ edit class flow â€“ would open school-edit-class.html?id='+classId));
    attendanceBtn.addEventListener('click', () => alert('ðŸ“‹ take attendance for ' + (classData?.name || 'class')));
    backBtn.addEventListener('click', () => window.location.href = 'school-classes.html');
</script>
</body>
</html>
