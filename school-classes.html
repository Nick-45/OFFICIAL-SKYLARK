<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDUSKYLARK · Classes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --school-green: #27ae60;
            --school-green-dark: #229954;
            --dark-blue: #2c3e50;
            --white: #ffffff;
            --light-blue: #ecf0f1;
            --blue: #3498db;
            --orange: #e67e22;
            --red: #e74c3c;
            --purple: #9b59b6;
            --teal: #1abc9c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #ecf0f1 0%, #d6dbdf 100%); min-height: 100vh; }
        .background-animation { position: fixed; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .bubble { position: absolute; border-radius: 50%; background: rgba(39,174,96,0.1); animation: float 15s infinite ease-in-out; }
        .bubble:nth-child(1) { width: 200px; height: 200px; top: 10%; left: 5%; animation-duration: 18s; }
        .bubble:nth-child(2) { width: 300px; height: 300px; bottom: 10%; right: 5%; animation-duration: 22s; background: rgba(52,152,219,0.08); }
        .bubble:nth-child(3) { width: 150px; height: 150px; top: 40%; right: 20%; animation-duration: 14s; }
        .bubble:nth-child(4) { width: 250px; height: 250px; bottom: 20%; left: 15%; animation-duration: 20s; background: rgba(155,89,182,0.08); }
        @keyframes float { 0%,100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-20px) scale(1.05); } }
        .header { background: linear-gradient(135deg, #2c3e50, #1a2530); color: white; padding: 20px 30px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; }
        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo { width: 60px; height: 60px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .logo img { width: 40px; height: 40px; object-fit: contain; }
        .church-info h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .church-info p { color: var(--school-green); font-size: 14px; }
        .school-badge { background: linear-gradient(135deg, var(--school-green), var(--school-green-dark)); color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px; margin-left: 10px; display: inline-block; }
        .dashboard-container { max-width: 1400px; margin: 30px auto; padding: 0 20px; animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
        }
        .page-header h2 { font-size: 28px; display: flex; align-items: center; gap: 15px; }
        .page-header h2 i { color: var(--teal); }
        
        .stats-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; border-radius: 16px; padding: 25px; border-left: 5px solid var(--teal);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-value { font-size: 36px; font-weight: 800; color: var(--dark-blue); }
        .stat-label { color: #7f8c8d; margin-top: 5px; font-weight: 500; }
        
        .filter-bar {
            background: white; border-radius: 16px; padding: 20px; margin-bottom: 30px;
            display: flex; flex-wrap: wrap; align-items: center; gap: 20px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.03);
        }
        .filter-select, .grade-select { 
            padding: 12px 25px; border: 2px solid #e9ecef; border-radius: 30px; background: white; 
            font-weight: 500; color: var(--dark-blue); cursor: pointer; outline: none;
        }
        .search-box {
            flex: 1; display: flex; align-items: center; background: #f9f9f9; border-radius: 30px;
            padding: 5px 5px 5px 20px; border: 2px solid #e9ecef; min-width: 280px;
        }
        .search-box input { flex: 1; padding: 12px 0; border: none; background: transparent; outline: none; font-size: 15px; }
        .search-box button {
            background: linear-gradient(135deg, var(--teal), #16a085);
            color: white; border: none; padding: 12px 25px; border-radius: 30px; cursor: pointer; font-weight: 600;
            transition: 0.2s; white-space: nowrap;
        }
        .search-box button:hover { opacity: 0.9; transform: scale(0.98); }
        
        .classes-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 25px;
        }
        .class-card {
            background: white; border-radius: 24px; padding: 0; overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); transition: all 0.3s; 
            border-bottom: 5px solid var(--teal);
        }
        .class-card:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        
        .class-header {
            background: linear-gradient(135deg, #1abc9c, #16a085);
            color: white; padding: 20px 25px; position: relative;
        }
        .class-header h3 { font-size: 26px; font-weight: 700; margin-bottom: 5px; }
        .class-header p { opacity: 0.9; font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .class-badge {
            position: absolute; top: 15px; right: 20px; background: rgba(255,255,255,0.2);
            padding: 5px 15px; border-radius: 50px; font-weight: 600; font-size: 14px;
        }
        .class-body { padding: 20px 25px; }
        .class-detail {
            display: flex; align-items: center; gap: 15px; margin-bottom: 15px;
            color: #2c3e50; font-size: 15px;
        }
        .class-detail i { width: 22px; color: var(--teal); }
        .teacher-chip {
            background: #ecf0f1; border-radius: 50px; padding: 5px 15px;
            display: inline-flex; align-items: center; gap: 8px; font-size: 14px;
        }
        .student-count {
            font-size: 15px; font-weight: 600; color: var(--dark-blue);
        }
        .class-footer {
            padding: 15px 25px 20px; border-top: 1px solid #ecf0f1;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-view {
            background: rgba(26,188,156,0.1); color: var(--teal); border: none;
            padding: 8px 25px; border-radius: 30px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-view:hover { background: var(--teal); color: white; }
        
        .add-btn {
            background: linear-gradient(135deg, var(--teal), #16a085);
            color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: 600;
            display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s; border: 2px solid transparent;
        }
        .add-btn:hover { opacity: 0.9; transform: scale(1.02); }

        .logout-btn {
            background: rgba(231,76,60,0.15); color: white; border: 2px solid var(--red); 
            padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: 600;
            transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .logout-btn:hover { background: var(--red); }

        .empty-state { text-align: center; padding: 60px; background: white; border-radius: 30px; grid-column: 1 / -1; color: #95a5a6; }
        .empty-state i { font-size: 60px; margin-bottom: 20px; color: #d5dbdb; }
        
        .footer-note { margin-top: 40px; text-align: center; color: #7f8c8d; font-size: 14px; border-top: 1px solid rgba(0,0,0,0.05); padding: 20px; }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo"><img src="https://cdn-icons-png.flaticon.com/512/217/217853.png" alt="EDUSKYLARK"></div>
                <div class="church-info">
                    <h1>EDUSKYLARK · CLASSES <span class="school-badge"><i class="fas fa-school"></i> <span id="schoolNameHeader">ACADEMICS</span></span></h1>
                    <p>Manage Classes & Sections · <span id="schoolNameSub">Loading...</span></p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <span style="color: white; background: rgba(39,174,96,0.2); padding: 5px 15px; border-radius: 30px;" id="adminInfo">
                    <i class="fas fa-user-shield"></i> <span id="adminName">Admin</span>
                </span>
                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </header>

    <main class="dashboard-container">
        <div class="page-header">
            <h2><i class="fas fa-layer-group"></i> Class directory</h2>
            <button class="add-btn" id="addClassBtn"><i class="fas fa-plus-circle"></i> Add class</button>
        </div>

        <!-- Stats cards (filled dynamically) -->
        <div class="stats-cards" id="statsContainer">
            <div class="stat-card"><div class="stat-value" id="totalClasses">0</div><div class="stat-label">Total classes</div></div>
            <div class="stat-card"><div class="stat-value" id="totalStudents">0</div><div class="stat-label">Enrolled students</div></div>
            <div class="stat-card"><div class="stat-value" id="avgClassSize">0</div><div class="stat-label">Avg class size</div></div>
            <div class="stat-card"><div class="stat-value" id="totalTeachersAssigned">0</div><div class="stat-label">Teachers assigned</div></div>
        </div>

        <!-- Filter bar -->
        <div class="filter-bar">
            <select class="grade-select" id="gradeFilter">
                <option value="all">All grades</option>
                <option value="Grade 1">Grade 1</option>
                <option value="Grade 2">Grade 2</option>
                <option value="Grade 3">Grade 3</option>
                <option value="Grade 4">Grade 4</option>
                <option value="Grade 5">Grade 5</option>
                <option value="Grade 6">Grade 6</option>
                <option value="Grade 7">Grade 7</option>
                <option value="Grade 8">Grade 8</option>
                <option value="Grade 9">Grade 9</option>
                <option value="Grade 10">Grade 10</option>
                <option value="Grade 11">Grade 11</option>
                <option value="Grade 12">Grade 12</option>
            </select>
            <select class="filter-select" id="teacherFilter">
                <option value="all">All teachers</option>
                <!-- options will be populated from data -->
            </select>
            <div class="search-box">
                <input type="text" placeholder="Search class (e.g., 'Mathematics 10')" id="searchInput">
                <button id="searchBtn"><i class="fas fa-search"></i> Search</button>
            </div>
        </div>

        <!-- Classes grid -->
        <div class="classes-grid" id="classesGrid"></div>
        <div class="footer-note">EDUSKYLARK · class management · realtime firestore</div>
    </main>

    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAz5knhlAxZwUATy3mtW66Z6lHBrv4tUog",
            authDomain: "toplink-edu.firebaseapp.com",
            projectId: "toplink-edu",
            storageBucket: "toplink-edu.firebasestorage.app",
            messagingSenderId: "35786900143",
            appId: "1:35786900143:web:9e612336393d29324c0a5a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ========== DOM ELEMENTS ==========
        const schoolNameHeader = document.getElementById('schoolNameHeader');
        const schoolNameSub = document.getElementById('schoolNameSub');
        const adminName = document.getElementById('adminName');
        const logoutBtn = document.getElementById('logoutBtn');
        const addClassBtn = document.getElementById('addClassBtn');
        const classesGrid = document.getElementById('classesGrid');
        const totalClassesSpan = document.getElementById('totalClasses');
        const totalStudentsSpan = document.getElementById('totalStudents');
        const avgClassSizeSpan = document.getElementById('avgClassSize');
        const totalTeachersAssignedSpan = document.getElementById('totalTeachersAssigned');
        const gradeFilter = document.getElementById('gradeFilter');
        const teacherFilter = document.getElementById('teacherFilter');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        // ========== STATE ==========
        let currentUser = null;
        let adminData = null;           // from 'admins' collection
        let allClasses = [];             // raw class data
        let filteredClasses = [];
        let teacherOptions = new Set();   // for filter dropdown

        // ========== AUTH STATE LISTENER ==========
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'school-admin-login.html';
                return;
            }
            currentUser = user;
            await loadAdminData(user);
            if (!adminData) {
                console.error('No admin record found for this user');
                await auth.signOut();
                window.location.href = 'school-admin-login.html';
                return;
            }
            // Verify admin is active
            if (adminData.status !== 'Active') {
                alert('Your account is not active. Please contact super admin.');
                await auth.signOut();
                window.location.href = 'school-admin-login.html';
                return;
            }
            // Update UI with admin info
            updateUI();
            
            // Set up real-time listener for classes
            setupClassesListener();
        });

        // ========== LOAD ADMIN DATA FROM 'admins' COLLECTION ==========
        async function loadAdminData(user) {
            try {
                const adminsQuery = await db.collection('admins')
                    .where('authUid', '==', user.uid)
                    .limit(1)
                    .get();

                if (!adminsQuery.empty) {
                    adminData = adminsQuery.docs[0].data();
                    adminData.id = adminsQuery.docs[0].id;
                    console.log('Admin data loaded:', adminData);
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        // ========== UPDATE UI WITH ADMIN DATA ==========
        function updateUI() {
            if (!adminData) return;
            
            // Display admin name
            const fullName = adminData.name || 'School Administrator';
            adminName.textContent = fullName.split(' ')[0] || 'Admin';
            
            // Display school name
            const schoolName = adminData.school || 'Your School';
            schoolNameHeader.textContent = schoolName;
            schoolNameSub.textContent = schoolName;
        }

        // ========== SETUP CLASSES LISTENER ==========
        function setupClassesListener() {
            if (!adminData) return;

            // Build query based on available school identifier
            let classesQuery;
            if (adminData.schoolId) {
                classesQuery = db.collection('classes')
                    .where('schoolId', '==', adminData.schoolId);
            } else {
                classesQuery = db.collection('classes')
                    .where('school', '==', adminData.school);
            }

            classesQuery.onSnapshot(snapshot => {
                allClasses = [];
                teacherOptions.clear();
                
                snapshot.forEach(doc => {
                    const cls = { id: doc.id, ...doc.data() };
                    allClasses.push(cls);
                    if (cls.teacherName) teacherOptions.add(cls.teacherName);
                });
                
                populateTeacherFilter();
                applyFilters();
            }, error => {
                console.error('Firestore error, using mock data', error);
                useMockData();
            });
        }

        // ========== POPULATE TEACHER FILTER ==========
        function populateTeacherFilter() {
            let html = '<option value="all">All teachers</option>';
            [...teacherOptions].sort().forEach(t => {
                html += `<option value="${t}">${t}</option>`;
            });
            teacherFilter.innerHTML = html;
        }

        // ========== MOCK DATA (if no classes exist) ==========
        function useMockData() {
            if (!adminData) return;
            const schoolName = adminData.school || 'Demo School';
            
            allClasses = [
                { id: 'c1', name: 'Mathematics 10A', grade: 'Grade 10', teacherName: 'Emily Clarke', studentCount: 28, room: '201', schedule: 'Mon/Wed 10:30', school: schoolName },
                { id: 'c2', name: 'Physics 11', grade: 'Grade 11', teacherName: 'James Okonkwo', studentCount: 24, room: '305', schedule: 'Tue/Thu 08:00', school: schoolName },
                { id: 'c3', name: 'English Literature 9', grade: 'Grade 9', teacherName: 'Sophie Müller', studentCount: 30, room: '112', schedule: 'Mon/Wed/Fri 13:00', school: schoolName },
                { id: 'c4', name: 'World History 10', grade: 'Grade 10', teacherName: 'David Kim', studentCount: 26, room: '204', schedule: 'Tue/Thu 14:30', school: schoolName },
                { id: 'c5', name: 'Chemistry 12', grade: 'Grade 12', teacherName: 'Maria Santos', studentCount: 18, room: '401', schedule: 'Wed/Fri 09:00', school: schoolName },
                { id: 'c6', name: 'Algebra 8', grade: 'Grade 8', teacherName: 'John Agyekum', studentCount: 32, room: '108', schedule: 'Mon/Wed 08:30', school: schoolName },
                { id: 'c7', name: 'French 7', grade: 'Grade 7', teacherName: 'Linda Zhang', studentCount: 22, room: '109', schedule: 'Tue/Thu 11:00', school: schoolName },
            ];
            teacherOptions.clear();
            allClasses.forEach(c => { if (c.teacherName) teacherOptions.add(c.teacherName); });
            populateTeacherFilter();
            applyFilters();
        }

        // ========== FILTER + RENDER ==========
        function applyFilters() {
            const grade = gradeFilter.value;
            const teacher = teacherFilter.value;
            const query = searchInput.value.trim().toLowerCase();

            filteredClasses = allClasses.filter(c => {
                if (grade !== 'all' && c.grade !== grade) return false;
                if (teacher !== 'all' && c.teacherName !== teacher) return false;
                if (query) {
                    return c.name?.toLowerCase().includes(query) || 
                           c.teacherName?.toLowerCase().includes(query) || 
                           c.room?.toLowerCase().includes(query);
                }
                return true;
            });

            updateStats();
            renderClasses();
        }

        // ========== UPDATE STATS ==========
        function updateStats() {
            totalClassesSpan.textContent = filteredClasses.length;
            const totalStudents = filteredClasses.reduce((acc, c) => acc + (c.studentCount || 0), 0);
            totalStudentsSpan.textContent = totalStudents;
            const avg = filteredClasses.length ? Math.round(totalStudents / filteredClasses.length) : 0;
            avgClassSizeSpan.textContent = avg;

            const uniqueTeachers = new Set(filteredClasses.map(c => c.teacherName).filter(Boolean)).size;
            totalTeachersAssignedSpan.textContent = uniqueTeachers;
        }

        // ========== RENDER CLASSES ==========
        function renderClasses() {
            if (filteredClasses.length === 0) {
                classesGrid.innerHTML = `<div class="empty-state"><i class="fas fa-chalkboard"></i><h3>No classes found</h3><p>Try adjusting filters or add a new class.</p></div>`;
                return;
            }

            let html = '';
            filteredClasses.forEach(c => {
                html += `
                    <div class="class-card" data-id="${c.id}">
                        <div class="class-header">
                            <h3>${c.name || 'Unnamed class'}</h3>
                            <p><i class="fas fa-users"></i> ${c.studentCount || 0} students · ${c.grade || '—'}</p>
                            <span class="class-badge">${c.room || '—'}</span>
                        </div>
                        <div class="class-body">
                            <div class="class-detail"><i class="fas fa-chalkboard-teacher"></i> <span class="teacher-chip"><i class="fas fa-user"></i> ${c.teacherName || 'Not assigned'}</span></div>
                            <div class="class-detail"><i class="far fa-clock"></i> ${c.schedule || 'Schedule TBA'}</div>
                            <div class="class-detail"><i class="fas fa-map-pin"></i> Room ${c.room || '—'}</div>
                        </div>
                        <div class="class-footer">
                            <span class="student-count"><i class="fas fa-user-graduate"></i> ${c.studentCount || 0} enrolled</span>
                            <button class="btn-view view-class" data-id="${c.id}"><i class="fas fa-eye"></i> View</button>
                        </div>
                    </div>
                `;
            });
            classesGrid.innerHTML = html;

            document.querySelectorAll('.view-class').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = btn.dataset.id;
                    // Store class ID for details page
                    sessionStorage.setItem('viewClassId', id);
                    alert(`View details for class ID: ${id}\n(Would navigate to class profile page.)`);
                });
            });
        }

     // ========== EVENT LISTENERS ==========

// Filters
gradeFilter.addEventListener('change', applyFilters);
teacherFilter.addEventListener('change', applyFilters);
searchBtn.addEventListener('click', applyFilters);

searchInput.addEventListener('keyup', (e) => {
    if (e.key === 'Enter') applyFilters();
});

// Logout
logoutBtn.addEventListener('click', async () => {
    try {
        await auth.signOut();
        window.location.href = 'school-admin-login.html';
    } catch (error) {
        console.error('Logout error:', error);
        alert('Failed to log out. Please try again.');
    }
});

// Add Class → Open create class page
addClassBtn.addEventListener('click', () => {
    window.location.href = 'school-create-class.html';
});


        // Fallback mock if no data after 4 seconds
        setTimeout(() => {
            if (allClasses.length === 0 && adminData) useMockData();
        }, 4000);
    </script>
</body>
</html>
